[
    {
        "content": "<p>When using zygote, I get a type instability only on a gpu version of code.  Any pointers on what to do about this?</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">using</span> <span class=\"n\">Zygote</span>\n<span class=\"k\">using</span> <span class=\"n\">CUDA</span>\n\n<span class=\"c\"># Works!</span>\n<span class=\"n\">term</span> <span class=\"o\">=</span> <span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"kt\">Float32</span><span class=\"p\">,</span> <span class=\"mi\">100</span><span class=\"p\">)</span>\n<span class=\"n\">gradient</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">Float32</span> <span class=\"o\">-&gt;</span> <span class=\"n\">sum</span><span class=\"p\">(</span><span class=\"n\">ifelse</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"n\">term</span> <span class=\"o\">.&gt;</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">term</span> <span class=\"o\">.+</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">term</span><span class=\"p\">)),</span> <span class=\"kt\">Float32</span><span class=\"p\">(</span><span class=\"mf\">5.</span><span class=\"p\">))</span>\n\n<span class=\"c\"># Doesn't Work!</span>\n<span class=\"n\">term</span> <span class=\"o\">=</span> <span class=\"n\">CUDA</span><span class=\"o\">.</span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"kt\">Float32</span><span class=\"p\">,</span> <span class=\"mi\">100</span><span class=\"p\">)</span>\n<span class=\"n\">gradient</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">Float32</span> <span class=\"o\">-&gt;</span> <span class=\"n\">sum</span><span class=\"p\">(</span><span class=\"n\">ifelse</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"n\">term</span> <span class=\"o\">.&gt;</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">term</span> <span class=\"o\">.+</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">term</span><span class=\"p\">)),</span> <span class=\"kt\">Float32</span><span class=\"p\">(</span><span class=\"mf\">5.</span><span class=\"p\">))</span>\n</code></pre></div>",
        "id": 240824771,
        "sender_full_name": "Jimmie Butler",
        "timestamp": 1622462545
    },
    {
        "content": "<p>IIRC Zygote uses <a href=\"https://github.com/search?q=ForwardDiff.jl&amp;type=Repositories\">ForwardDiff.jl</a> for broadcasts on the GPU, so that could be the difference you are seeing here. Generally the best way to debug issues like this is to step through the code using <a href=\"https://github.com/search?q=Cthulhu.jl&amp;type=Repositories\">Cthulhu.jl</a>.</p>",
        "id": 240861950,
        "sender_full_name": "Simeon Schaub",
        "timestamp": 1622486846
    }
]