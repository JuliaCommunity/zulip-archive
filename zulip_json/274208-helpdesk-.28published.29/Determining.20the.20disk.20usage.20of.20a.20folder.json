[
    {
        "content": "<p>I _almost_ have a <code>du -B1</code> replacement in Julia, but in the odd directory it's slightly off (undercounting by a little bit), and I can't for the life of me work out why. Any help would be much appreciated.</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"s\">\"\"\"</span>\n<span class=\"s\">    diskusage(path::String)</span>\n\n<span class=\"s\">Find the disk usage of `path`, in bytes (as `du -B1` does). This is almost</span>\n<span class=\"s\">eqivalent to [`filesize`](@ref) when applied to a file, and operates recursively</span>\n<span class=\"s\">on directories.</span>\n<span class=\"s\">\"\"\"</span>\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">diskusage</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"o\">::</span><span class=\"kt\">String</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isfile</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">st</span><span class=\"o\">.</span><span class=\"n\">blocks</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"c\"># 512 not the blocksize for historical reasons</span>\n<span class=\"w\">    </span><span class=\"k\">elseif</span><span class=\"w\"> </span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"k\">try</span>\n<span class=\"w\">            </span><span class=\"n\">subpaths</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">readdir</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">join</span><span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"n\">filter!</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">islink</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">subpaths</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"n\">sum</span><span class=\"p\">(</span><span class=\"n\">diskusage</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">subpaths</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">.</span><span class=\"n\">blksize</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">st</span><span class=\"o\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">รท</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">.</span><span class=\"n\">blksize</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"n\">err</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"k\">isa</span><span class=\"w\"> </span><span class=\"n\">Base</span><span class=\"o\">.</span><span class=\"n\">IOError</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">.</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Base</span><span class=\"o\">.</span><span class=\"n\">Libc</span><span class=\"o\">.</span><span class=\"n\">EACCES</span><span class=\"w\"> </span><span class=\"c\"># Permission denied</span>\n<span class=\"w\">                </span><span class=\"n\">printstyled</span><span class=\"p\">(</span><span class=\"nb\">stderr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"[ Warning: \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"o\">=</span><span class=\"n\">Base</span><span class=\"o\">.</span><span class=\"n\">warn_color</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">bold</span><span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"n\">println</span><span class=\"p\">(</span><span class=\"nb\">stderr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"Couldn't read </span><span class=\"si\">$path</span><span class=\"s\">: Permission denied\"</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"mi\">0</span>\n<span class=\"w\">            </span><span class=\"k\">else</span>\n<span class=\"w\">                </span><span class=\"n\">rethrow</span><span class=\"p\">()</span>\n<span class=\"w\">            </span><span class=\"k\">end</span>\n<span class=\"w\">        </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 393067891,
        "sender_full_name": "Timothy",
        "timestamp": 1695661881
    },
    {
        "content": "<p>what's that <code>st.blksize * (st.size รท st.blksize)</code> about? Isn't that essentially <code>floor(st.size)</code>, and if so, do you actually want it to be?</p>",
        "id": 393068638,
        "sender_full_name": "Sebastian Pfitzner",
        "timestamp": 1695662156
    },
    {
        "content": "<p>When directories have many items, they seem to start taking up blocks. When <code>st.size</code> is say 400 I want 0, when it's say 9000 I want 4096 * 2. At least from my experiments so far, this seems about right.</p>",
        "id": 393068894,
        "sender_full_name": "Timothy",
        "timestamp": 1695662248
    },
    {
        "content": "<p>Here's me being slightly off in practice:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">diskusage</span><span class=\"p\">(</span><span class=\"s\">\"/home/tec/Desktop/\"</span><span class=\"p\">)</span>\n<span class=\"mi\">5505024</span>\n\n<span class=\"n\">shell</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">B1</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Desktop</span><span class=\"o\">/</span>\n<span class=\"mi\">5505024</span><span class=\"w\">    </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Desktop</span><span class=\"o\">/</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">diskusage</span><span class=\"p\">(</span><span class=\"s\">\"/home/tec/Documents/\"</span><span class=\"p\">)</span>\n<span class=\"mi\">29516001280</span>\n\n<span class=\"n\">shell</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">B1</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Documents</span><span class=\"o\">/</span>\n<span class=\"mi\">29517352960</span><span class=\"w\">    </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Documents</span><span class=\"o\">/</span>\n\n<span class=\"n\">shell</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">B1</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Videos</span><span class=\"o\">/</span>\n<span class=\"mi\">171021414400</span><span class=\"w\">    </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Videos</span><span class=\"o\">/</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">diskusage</span><span class=\"p\">(</span><span class=\"s\">\"/home/tec/Music/\"</span><span class=\"p\">)</span>\n<span class=\"mi\">280397500416</span>\n\n<span class=\"n\">shell</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">d0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">B1</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Music</span><span class=\"o\">/</span>\n<span class=\"mi\">280397402112</span><span class=\"w\">    </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">tec</span><span class=\"o\">/</span><span class=\"n\">Music</span><span class=\"o\">/</span>\n</code></pre></div>\n<p><code>~/Videos</code> is off by 4 blocks (0.000001%), <code>~/Documents</code> is off by 330 blocks (0.001%), etc.</p>",
        "id": 393069731,
        "sender_full_name": "Timothy",
        "timestamp": 1695662507
    },
    {
        "content": "<p>hm, makes sense I guess</p>",
        "id": 393070684,
        "sender_full_name": "Sebastian Pfitzner",
        "timestamp": 1695662743
    },
    {
        "content": "<p>This is just guesswork. I'm struggling to find any documentation of the details here.</p>",
        "id": 393070909,
        "sender_full_name": "Timothy",
        "timestamp": 1695662786
    },
    {
        "content": "<p>Ah, I think I've found a minor error in the <code>stat</code> documentation. This seems wrong:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">blksize</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">-</span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">preferred</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">file</span>\n<span class=\"w\">  </span><span class=\"n\">blocks</span><span class=\"w\">  </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">blocks</span><span class=\"w\"> </span><span class=\"n\">allocated</span>\n</code></pre></div>",
        "id": 393071972,
        "sender_full_name": "Timothy",
        "timestamp": 1695663119
    },
    {
        "content": "<p><a href=\"https://github.com/JuliaLang/julia/issues/51447\">https://github.com/JuliaLang/julia/issues/51447</a></p>",
        "id": 393072958,
        "sender_full_name": "Timothy",
        "timestamp": 1695663450
    }
]