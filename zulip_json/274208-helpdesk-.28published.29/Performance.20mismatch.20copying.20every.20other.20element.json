[
    {
        "content": "<p>I've run across an interesting performance problem I can't quite get my head around and I'm wondering if anyone has advice on diagnosing it. </p>\n<p>Consider the following 4 functions that all do the same thing:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">f1!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nd\">@inbounds</span><span class=\"w\"> </span><span class=\"nd\">@simd</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">∈</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">src_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n<span class=\"w\">        </span><span class=\"n\">dst</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src_i</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"n\">dst</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">f2!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nd\">@assert</span><span class=\"w\"> </span><span class=\"n\">isbitstype</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nd\">@inbounds</span><span class=\"w\"> </span><span class=\"nd\">@simd</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">∈</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">src_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsafe_load</span><span class=\"p\">(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">dst</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src_i</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"n\">dst</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">f3!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nd\">@assert</span><span class=\"w\"> </span><span class=\"n\">isbitstype</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nd\">@inbounds</span><span class=\"w\"> </span><span class=\"nd\">@simd</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">∈</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">src_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n<span class=\"w\">        </span><span class=\"n\">unsafe_store!</span><span class=\"p\">(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">src_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"n\">dst</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">f4!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nd\">@assert</span><span class=\"w\"> </span><span class=\"n\">isbitstype</span><span class=\"p\">(</span><span class=\"n\">T</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nd\">@simd</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">∈</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">src_i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unsafe_load</span><span class=\"p\">(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">unsafe_store!</span><span class=\"p\">(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">src_i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"n\">dst</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>i.e. they all are copying every other element of <code>dst</code> into <code>src</code>. </p>\n<ul>\n<li><code>f1!</code> is using regular <code>getindex</code> / <code>setindex!</code>, </li>\n<li><code>f4!</code> is using <code>unsafe_load</code> and <code>unsafe_store!</code> on the pointers<br>\n<code>f2!</code> and <code>f3!</code> use a mixture of of the two (i.e. <code>getindex</code> with <code>unsafe_store!</code>, and <code>unsafe_load</code> to <code>setindex!</code>). </li>\n</ul>\n<p>When I benchmark them, I find that the mixed functions <code>f2!</code> and <code>f3!</code> are significantly faster than the unmixed functions <code>f1!</code> and <code>f2!</code>. Any idea what could be causing this? My primary interest is in making <code>f4!</code> as fast as <code>f2!</code>/<code>f3!</code></p>",
        "id": 556677977,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763291114
    },
    {
        "content": "<p>Here's an example benchmark:</p>\n<div class=\"codehilite\" data-code-language=\"Julia console\"><pre><span></span><code><span class=\"gp\">julia&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span>\n<span class=\"w\">           </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f1!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f1!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f2!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f2!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f3!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f3!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f4!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f4!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"nb\">nothing</span>\n<span class=\"w\">       </span><span class=\"k\">end</span><span class=\"p\">;</span>\n<span class=\"go\">f1!:   257.917 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f2!:   81.792 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f3!:   79.757 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f4!:   260.740 ns (0 allocations: 0 bytes)</span>\n</code></pre></div>",
        "id": 556678121,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763291275
    },
    {
        "content": "<p>for <code>f4!</code>: perhaps assumed pointer aliasing/provenance prevents vectorization?</p>",
        "id": 556678227,
        "sender_full_name": "Sukera",
        "timestamp": 1763291380
    },
    {
        "content": "<p>What confuses me though is that it matches the perf of <code>f1!</code>.</p>",
        "id": 556678263,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763291416
    },
    {
        "content": "<p>Here's perhaps another piece to the wierdness puzzle here:</p>\n<p>This is slow:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span>\n<span class=\"w\">           </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">.=</span><span class=\"w\"> </span><span class=\"nd\">@view</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"p\">]</span>\n<span class=\"w\">       </span><span class=\"k\">end</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"mf\">255.112</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>but this is fast:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span>\n<span class=\"w\">           </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"kt\">ComplexF64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"kt\">ComplexF64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"p\">)</span>\n\n<span class=\"w\">           </span><span class=\"n\">src_r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">reinterpret</span><span class=\"p\">(</span><span class=\"n\">reshape</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Float64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">dst_r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">reinterpret</span><span class=\"p\">(</span><span class=\"n\">reshape</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Float64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">)</span>\n\n<span class=\"w\">           </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst_r</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">.=</span><span class=\"w\"> </span><span class=\"nd\">@view</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">src_r</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"p\">]</span>\n<span class=\"w\">       </span><span class=\"k\">end</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"mf\">88.521</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 556678643,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763291777
    },
    {
        "content": "<p>The other thing I was thinking is that the performance differential is smaller than I'd expect for SIMD versus no SIMD, but your comment makes me wonder if what's happening is that only the loads or only the stores are being vectorized in one case, whereas in the mixed cases perhaps it's tricking it into vectorizing both the loads and stores?</p>\n<p>If I disable SIMD completely using <code>Base.donotdelete</code>, I see that the loops take ~480ns the benchmark</p>",
        "id": 556678979,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763292164
    },
    {
        "content": "<p>I feel like I've screwed up somewhere but with a little change it can get faster:</p>\n<div class=\"codehilite\" data-code-language=\"Julia console\"><pre><span></span><code><span class=\"gp\">julia&gt;</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">f5!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"kt\">T</span><span class=\"p\">}</span>\n<span class=\"w\">           </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">eachindex</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">               </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iseven</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">                   </span><span class=\"k\">continue</span>\n<span class=\"w\">               </span><span class=\"k\">end</span>\n<span class=\"w\">               </span><span class=\"n\">dst</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n<span class=\"w\">           </span><span class=\"k\">end</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span>\n<span class=\"w\">       </span><span class=\"k\">end</span>\n<span class=\"go\">f5! (generic function with 1 method)</span>\n\n<span class=\"gp\">julia&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">800</span>\n<span class=\"w\">           </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f1!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f1!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f2!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f2!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f3!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f3!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f4!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f4!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"f5!: \"</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"nd\">@btime</span><span class=\"w\"> </span><span class=\"n\">f5!</span><span class=\"p\">(</span><span class=\"o\">$</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"n\">dst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">f5!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">))</span>\n<span class=\"w\">           </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">f1!</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">))</span>\n<span class=\"w\">           </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">       </span><span class=\"k\">end</span>\n<span class=\"go\">f1!:   190.867 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f2!:   74.897 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f3!:   75.000 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f4!:   190.867 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">f5!:   45.399 ns (0 allocations: 0 bytes)</span>\n<span class=\"go\">true</span>\n</code></pre></div>",
        "id": 556679343,
        "sender_full_name": "wheeheee",
        "timestamp": 1763292582
    },
    {
        "content": "<p>Bizarre. This does lend some credence to the idea that it's down to different ways that vectorization choices can be made. </p>\n<p>Unfortunately I can't really use that style in my actual application (trying to improve <code>copyto!</code> performance of <a href=\"https://juliaregistries.github.io/General/packages/redirect_to_repo/FieldViews\">FieldViews.jl</a>)</p>",
        "id": 556680382,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763293828
    },
    {
        "content": "<p>Yeah, many seemingly small things cause missed optimizations on Julia. But this one feels especially bad, coz the code is super straightforward.</p>",
        "id": 556684885,
        "sender_full_name": "wheeheee",
        "timestamp": 1763298961
    },
    {
        "content": "<p>From what I gather (pun-unintended) <code>f5!</code> uses <code>@llvm.masked.load.v4f64.p0</code> while <code>f1!</code> (and i assume the rest) uses <code>@llvm.masked.gather.v4f64.v4p0</code>, so using gathers here seems to be the problem</p>",
        "id": 556684966,
        "sender_full_name": "wheeheee",
        "timestamp": 1763299056
    },
    {
        "content": "<p>maybe you should open an issue? similar performance bugs have surfaced before involving gathers</p>",
        "id": 556685146,
        "sender_full_name": "wheeheee",
        "timestamp": 1763299284
    },
    {
        "content": "<p><a href=\"https://github.com/JuliaLang/julia/issues/60147\">https://github.com/JuliaLang/julia/issues/60147</a></p>",
        "id": 556690439,
        "sender_full_name": "Mason Protter",
        "timestamp": 1763304665
    },
    {
        "content": "<p>I think it makes sense that f5 is best, constructing and iterating over 1:2:length is probably pretty complicated at the llvm ir level and so worse optimized</p>",
        "id": 556945361,
        "sender_full_name": "Zentrik",
        "timestamp": 1763419864
    },
    {
        "content": "<p>That's really weird, I get totally different timings:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">f1!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">81.062</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n<span class=\"n\">f2!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">82.257</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n<span class=\"n\">f3!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">81.907</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n<span class=\"n\">f4!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">80.628</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n<span class=\"n\">f5!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">245.792</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>And on the benchmark from the issue you opened, the timings are reversed! :</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">copyto_odd1!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">80.659</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n<span class=\"n\">copyto_odd2!</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">246.441</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">allocations</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 557004773,
        "sender_full_name": "Rafael Fourquet",
        "timestamp": 1763454382
    },
    {
        "content": "<p>fwiw a straightforward translation of <code>copyto_odd1!</code> to Rust also doesn't vectorize, and a C++ version needs <code>g++ -O3</code> to vectorize somewhat like <code>copyto_odd2!</code>, so the compiler is actually already quite smart in <code>copyto_odd2!</code> (not that it can't be better)</p>",
        "id": 557880186,
        "sender_full_name": "wheeheee",
        "timestamp": 1763458786
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"269303\">@Rafael Fourquet</span> what's the output of <code>versioninfo</code> on your machine?</p>",
        "id": 557880323,
        "sender_full_name": "wheeheee",
        "timestamp": 1763458822
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"670625\">wheeheee</span> <a href=\"#narrow/channel/274208-helpdesk-.28published.29/topic/Performance.20mismatch.20copying.20every.20other.20element/near/557880323\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"269303\">Rafael Fourquet</span> what's the output of <code>versioninfo</code> on your machine?</p>\n</blockquote>\n<p>This is on all recent julia versions, from v1.10 onwards. <code>versioninfo()</code> on v1.12 gives</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"mi\">6</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">versioninfo</span><span class=\"p\">()</span>\n<span class=\"n\">Julia</span><span class=\"w\"> </span><span class=\"n\">Version</span><span class=\"w\"> </span><span class=\"mf\">1.12.1</span>\n<span class=\"n\">Commit</span><span class=\"w\"> </span><span class=\"n\">d05709ca652</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">11</span><span class=\"o\">-</span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"o\">:</span><span class=\"mi\">06</span><span class=\"w\"> </span><span class=\"n\">UTC</span><span class=\"p\">)</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Official</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">://</span><span class=\"n\">julialang</span><span class=\"o\">.</span><span class=\"n\">org</span><span class=\"w\"> </span><span class=\"n\">release</span>\n<span class=\"n\">Platform</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">OS</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linux</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">CPU</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">×</span><span class=\"w\"> </span><span class=\"n\">AMD</span><span class=\"w\"> </span><span class=\"n\">Ryzen</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"mi\">5950</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">-</span><span class=\"n\">Core</span><span class=\"w\"> </span><span class=\"n\">Processor</span>\n<span class=\"w\">  </span><span class=\"n\">WORD_SIZE</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">64</span>\n<span class=\"w\">  </span><span class=\"n\">LLVM</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">libLLVM</span><span class=\"o\">-</span><span class=\"mf\">18.1.7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ORCJIT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">znver3</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">GC</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">stock</span><span class=\"w\"> </span><span class=\"n\">GC</span>\n<span class=\"n\">Threads</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">interactive</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">GC</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">virtual</span><span class=\"w\"> </span><span class=\"n\">cores</span><span class=\"p\">)</span>\n<span class=\"n\">Environment</span><span class=\"o\">:</span>\n<span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">]</span>\n</code></pre></div>",
        "id": 557978988,
        "sender_full_name": "Rafael Fourquet",
        "timestamp": 1763482095
    },
    {
        "content": "<p>Interesting, does the <code>vector.body</code> section from code_llvm also show the gather/scatter and masked load/stores or is it reversed for you?</p>",
        "id": 557981741,
        "sender_full_name": "wheeheee",
        "timestamp": 1763482692
    },
    {
        "content": "<p>ig the optimization passes are a tad brittle</p>",
        "id": 557982261,
        "sender_full_name": "wheeheee",
        "timestamp": 1763482765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"670625\">wheeheee</span> <a href=\"#narrow/channel/274208-helpdesk-.28published.29/topic/Performance.20mismatch.20copying.20every.20other.20element/near/557981741\">said</a>:</p>\n<blockquote>\n<p>Interesting, does the <code>vector.body</code> section from code_llvm also show the gather/scatter and masked load/stores or is it reversed for you?</p>\n</blockquote>\n<p>I don't see any gather/scatter, only some <code>@llvm.masked.store</code> and <code>@llvm.masked.load</code> for <code>f5!</code>.</p>",
        "id": 557984130,
        "sender_full_name": "Rafael Fourquet",
        "timestamp": 1763483126
    },
    {
        "content": "<p>for f1!, what’s in vector.body? Would be a very curious situation if it also uses gather/scatters and is still faster…</p>",
        "id": 557984686,
        "sender_full_name": "wheeheee",
        "timestamp": 1763483261
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"670625\">wheeheee</span> <a href=\"#narrow/channel/274208-helpdesk-.28published.29/topic/Performance.20mismatch.20copying.20every.20other.20element/near/557984686\">said</a>:</p>\n<blockquote>\n<p>for f1!, what’s in vector.body? Would be a very curious situation if it also uses gather/scatters and is still faster…</p>\n</blockquote>\n<p>There's no <code>vector.body</code> in the other <code>f_i!</code>s for me, only for <code>f5!</code> !</p>",
        "id": 557994940,
        "sender_full_name": "Rafael Fourquet",
        "timestamp": 1763485606
    },
    {
        "content": "<p>weird, I see <code>vector.body</code> in f1!. what's your code_llvm output for <code>copyto_odd1!</code> and <code>copyto_odd2!</code>?</p>",
        "id": 558224589,
        "sender_full_name": "wheeheee",
        "timestamp": 1763563928
    },
    {
        "content": "<p>ok i see in f2! and f3! there's loop unrolling but no gather/scatter, so there's a long main loop right after the preheader, but no <code>vector.body</code></p>",
        "id": 558226628,
        "sender_full_name": "wheeheee",
        "timestamp": 1763564373
    }
]