[
    {
        "content": "<p>Say I have a loop like:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">100000</span>\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">100000</span>\n<span class=\"w\">    </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">continue</span><span class=\"w\"> </span><span class=\"c\"># avoid double counting</span>\n<span class=\"w\">    </span><span class=\"c\"># do some actual work</span>\n<span class=\"w\">  </span><span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>where the condition <code>i &lt;= j</code> is used to skip the inner loop iterations. Is there any performance decrease to define this skip condition with dispatch?</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">skipfun</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">MyType1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">j</span>\n<span class=\"n\">skipfun</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">MyType2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">false</span>\n</code></pre></div>\n<p>If I replace the literal <code>i &lt;= j</code> in the loop by a call to these lambda functions, should I expect slow down or the compiler is good enough to cleanup the code? How would you investigate it further with existing Julia tools?</p>",
        "id": 377936930,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1690149104
    },
    {
        "content": "<p>Are you capturing i and j from outer scope? That could be a problem</p>",
        "id": 378024428,
        "sender_full_name": "Mosè Giordano",
        "timestamp": 1690185287
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 378042049,
        "sender_full_name": "Leandro Martínez",
        "timestamp": 1690188711
    },
    {
        "content": "<p>On the other side, why not:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">skipfun</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">MyType1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">j</span>\n<span class=\"n\">skipfun</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">MyType2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span>\n</code></pre></div>\n<p>to be used with, within the loop:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">skipfun</span><span class=\"p\">(</span><span class=\"n\">MyType1</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">continue</span>\n</code></pre></div>\n<p>That certainly has no signficant overhead relative to the conditional.</p>\n<p>Or, if the conditional is already a problem (in the case it is unnecessary), define one iterator for each type, like:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"kt\">A</span><span class=\"w\"> </span><span class=\"k\">end</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"kt\">B</span><span class=\"w\"> </span><span class=\"k\">end</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">A</span><span class=\"p\">,</span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"n\">m</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Iterators</span><span class=\"o\">.</span><span class=\"n\">product</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">m</span><span class=\"p\">)</span>\n<span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">generic</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">methods</span><span class=\"p\">)</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">B</span><span class=\"p\">,</span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"n\">m</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Iterators</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">Iterators</span><span class=\"o\">.</span><span class=\"n\">product</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">m</span><span class=\"p\">))</span>\n<span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">generic</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">methods</span><span class=\"p\">)</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"nd\">@show</span><span class=\"w\"> </span><span class=\"n\">pair</span>\n<span class=\"w\">       </span><span class=\"k\">end</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n\n<span class=\"n\">julia</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"n\">B</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"nd\">@show</span><span class=\"w\"> </span><span class=\"n\">pair</span>\n<span class=\"w\">       </span><span class=\"k\">end</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 378074134,
        "sender_full_name": "Leandro Martínez",
        "timestamp": 1690194103
    },
    {
        "content": "<p>Thank you all for the tips. I will proceed with the custom iterator approach, it is the most self-contained <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 378090622,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1690196184
    },
    {
        "content": "<p>I wonder how I could inspect the actual code generated by the compiler and see that the iterators are compiled away?</p>",
        "id": 378090751,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1690196215
    },
    {
        "content": "<p>I don't think they are compiled away in any sense. The result should be very similar to the actual loops without and with the conditional. It may be more efficient in the case of the conditional to write an iterator that only runs over the upper diagonal elements instead of filtering.</p>",
        "id": 378094394,
        "sender_full_name": "Leandro Martínez",
        "timestamp": 1690196958
    },
    {
        "content": "<p>(I wouldn't bet filter is smart enough to do that)</p>",
        "id": 378094752,
        "sender_full_name": "Leandro Martínez",
        "timestamp": 1690197030
    },
    {
        "content": "<p>In case you want to give it a try, here is the code in question:</p>\n<p><a href=\"https://github.com/JuliaEarth/Variography.jl/blob/b1e401eb8514fad469d9514693412caf6f9cda9c/src/empirical.jl#L73\">https://github.com/JuliaEarth/Variography.jl/blob/b1e401eb8514fad469d9514693412caf6f9cda9c/src/empirical.jl#L73</a></p>\n<p>The <code>skip</code> function is retrieved with dispatch from two different algorithm types.</p>",
        "id": 378107339,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1690199407
    },
    {
        "content": "<p>I commented there. In that situation, first, I would just dispatch to differnet <code>skip</code> mehods depending on the type, without using a closure.</p>",
        "id": 378200517,
        "sender_full_name": "Leandro Martínez",
        "timestamp": 1690215244
    }
]