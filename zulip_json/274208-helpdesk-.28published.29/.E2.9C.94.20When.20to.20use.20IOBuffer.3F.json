[
    {
        "content": "<p>Reading from <code>io = open(fname)</code> is much slower than reading from <code>IOBuffer(read(io))</code>. I understand that this is because all the bytes are copied to RAM.</p>\n<p>If we can guarantee that all bytes in <code>io</code> fit in RAM, then it is always better to use <code>IOBuffer</code> for speed?</p>",
        "id": 558806901,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763809642
    },
    {
        "content": "<p>How are you measuring? If you exclude the time it takes to reads the data into RAM for the IOBuffer from your measurement, of course it's faster.  Only the processing time is left after all. However, your overall application likely is not magically fast, because the data still has to be read into RAM.</p>",
        "id": 558810217,
        "sender_full_name": "Sukera",
        "timestamp": 1763813098
    },
    {
        "content": "<p>I am including the time it takes to create the <code>IOBuffer</code> and it is still faster.</p>",
        "id": 558810264,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763813150
    },
    {
        "content": "<p>Interesting <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> do you have an example?</p>",
        "id": 558812356,
        "sender_full_name": "Sukera",
        "timestamp": 1763815286
    },
    {
        "content": "<p>Can try to produce one with more time later. Currently trying to debug another issue.</p>",
        "id": 558813096,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763816023
    },
    {
        "content": "<p>The example could be as simple as reading a matrix of size 2500×25000 stored in the IO:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">25000</span>\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">2500</span>\n<span class=\"w\">    </span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Float64</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 558818722,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763821801
    },
    {
        "content": "<p>That is almost certainly because the file object (<code>IOStream</code>) has some overhead, mostly from taking a lock associated with the file. You can match the performance of the <code>IOBuffer</code> by buffering the file object in Julia. That is, you make a small buffer, e.g. a 16 KiB <code>Vector{UInt8}</code>, then read into that</p>",
        "id": 558828608,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763830887
    },
    {
        "content": "<p>You mean there is a method of <code>read</code> that accepts a small buffer to mutate?</p>",
        "id": 558828700,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763830975
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">help</span><span class=\"o\">?&gt;</span><span class=\"w\"> </span><span class=\"n\">read!</span>\n<span class=\"n\">search</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">read!</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"w\"> </span><span class=\"n\">real</span><span class=\"w\"> </span><span class=\"n\">rpad</span><span class=\"w\"> </span><span class=\"n\">readdir</span><span class=\"w\"> </span><span class=\"n\">Threads</span><span class=\"w\"> </span><span class=\"n\">isready</span><span class=\"w\"> </span><span class=\"n\">prepend!</span><span class=\"w\"> </span><span class=\"n\">readeach</span><span class=\"w\"> </span><span class=\"n\">readline</span><span class=\"w\"> </span><span class=\"n\">readlink</span><span class=\"w\"> </span><span class=\"n\">replace!</span>\n\n<span class=\"w\">  </span><span class=\"n\">read!</span><span class=\"p\">(</span><span class=\"n\">stream</span><span class=\"o\">::</span><span class=\"kt\">IO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"o\">::</span><span class=\"kt\">AbstractArray</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">read!</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"o\">::</span><span class=\"kt\">AbstractString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"o\">::</span><span class=\"kt\">AbstractArray</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">Read</span><span class=\"w\"> </span><span class=\"n\">binary</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">/</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">stream</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filling</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"o\">.</span>\n</code></pre></div>",
        "id": 558830797,
        "sender_full_name": "Gunnar Farnebäck",
        "timestamp": 1763832863
    },
    {
        "content": "<p>For what it's worth, I'm quite unhappy with the API that Base provides, which is why I made the package <a href=\"https://juliaregistries.github.io/General/packages/redirect_to_repo/BufferIO\">BufferIO.jl</a> to improve this area of Julia</p>",
        "id": 558831779,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763833750
    },
    {
        "content": "<p>For a more mature, though less efficient alternative, look at <a href=\"https://juliaregistries.github.io/General/packages/redirect_to_repo/BufferedStreams\">BufferedStreams.jl</a></p>",
        "id": 558831812,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763833783
    },
    {
        "content": "<p>Nice! One more thing to learn when I find some time <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 558832083,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763834052
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"273172\">Júlio Hoffimann</span> has marked this topic as resolved.</p>",
        "id": 558837033,
        "sender_full_name": "Notification Bot",
        "timestamp": 1763838572
    },
    {
        "content": "<p>There is also <a href=\"https://juliaregistries.github.io/General/packages/redirect_to_repo/InputBuffers\">InputBuffers.jl</a> which I made as an even faster less buggy version of <code>IOBuffer</code>. I also use this with a <code>FileArray</code> type to avoid using <code>IOStream</code> or mmap, which I have had problems with. <a href=\"https://github.com/JuliaIO/ZipArchives.jl/blob/c48c367b6208c9733ff0e2f3431a6b8d13939126/test/test_file-array.jl#L22\">https://github.com/JuliaIO/ZipArchives.jl/blob/c48c367b6208c9733ff0e2f3431a6b8d13939126/test/test_file-array.jl#L22</a></p>",
        "id": 559142772,
        "sender_full_name": "Nathan Zimmerberg",
        "timestamp": 1764015277
    },
    {
        "content": "<p>Still fighting with IO here, but seeing some progress.</p>",
        "id": 559143330,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1764015494
    },
    {
        "content": "<p>If you have the memory it will almost always be nicer to just read everything into memory first and do your your processing on a big <code>Vector{UInt8}</code>. Beyond performance doing this greatly simplifies the logic for error handling, because any IO errors can be handled up front, also, unlike <code>IO</code>, the <code>Vector</code> interface is well documented.</p>",
        "id": 559145224,
        "sender_full_name": "Nathan Zimmerberg",
        "timestamp": 1764016096
    }
]