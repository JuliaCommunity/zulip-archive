[
    {
        "content": "<p>Can anyone help me with a batch scheduling problem? </p>\n<p>Description: <br>\nI have a function FOO that I want to run on multiple threads at once. While FOO is running, it will occasionally call another function BAR with an argument unique to each thread that FOO is running on. I want BAR to batch process whatever FOO passes to it (say 32 at a time), and return the values to each unique thread that is running FOO. Is there a way to do this using the Task Library or Channel Library?</p>\n<p>If the description of foo and bar is too abstract, I essentially have threads running that each want to classify images, but I want to batch the images before sending them to the GPU to be classified.</p>",
        "id": 238931513,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621119722
    },
    {
        "content": "<p>Does FOO have to wait for BAR? If so, what's different from a simple blocking call after accumulating 32 elements?</p>\n<p>But, since you use GPU, maybe you want to pipeline several calls of BAR from each FOO?</p>",
        "id": 238932342,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621120587
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"297129\">Takafumi Arakaki (tkf)</span> <a href=\"#narrow/stream/274208-helpdesk-.28published.29/topic/Task.20and.20Channel.20for.20Batch.20Scheduling/near/238932342\">said</a>:</p>\n<blockquote>\n<p>Does FOO have to wait for BAR? If so, what's different from a simple blocking call after accumulating 32 elements?</p>\n<p>But, since you use GPU, maybe you want to pipeline several calls of BAR from each FOO?</p>\n</blockquote>\n<p>Yes, FOO needs to wait for BAR before it can continue. I essentially am just trying to figure out how to batch the calls, but ensure that each output from BAR goes to the exact FOO that called it. For example, I thought one way to do this might be create a tuples of the thread_id and the image, classify 32 at a time, and then let the worker threads take their respective images that they put in the channel for classification. But I was interested to know what the best mechanism for this type of idea is.</p>",
        "id": 238932544,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621120819
    },
    {
        "content": "<p>So, are 32 items coming from different tasks executing <code>FOO</code>? i.e., you want to combine 32 calls from different tasks to issue one GPU kernel call?</p>",
        "id": 238934475,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621123128
    },
    {
        "content": "<p>...and want to make sure the result of the call goes back to the correct  <code>FOO</code></p>",
        "id": 238934633,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621123271
    },
    {
        "content": "<p>Yes. Essentially, let’s say the </p>\n<p>Thread 1 calls G with arg 1<br>\nThread 2 calls G with arg 2 <br>\nEtc etc<br>\nThread n calls G with arg n</p>\n<p>I want G (the gpu) to operate on argument 1,2...n in batches of 32 while making sure the result of g on arg1 returns to thread 1, the result of arg2 returns to thread 2, etc.</p>",
        "id": 238934941,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621123584
    },
    {
        "content": "<p>OK, I now understand the question. You essentially need a promise (future). The easiest way to do this in Julia is to use single element \"one-shot\" <code>Channel</code> (I think Go programmers use it all the time).</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">)</span>\n    <span class=\"n\">batchsize</span> <span class=\"o\">=</span> <span class=\"mi\">32</span>\n    <span class=\"c\"># It's better to use two arrays but for now this is an array of 2-tuples :</span>\n    <span class=\"n\">batch</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">eltype</span><span class=\"p\">(</span><span class=\"kt\">Channel</span><span class=\"p\">)}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"k\">for</span> <span class=\"n\">r</span> <span class=\"k\">in</span> <span class=\"n\">request</span>\n        <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">batch</span><span class=\"p\">,</span> <span class=\"n\">r</span><span class=\"p\">)</span>\n        <span class=\"n\">nitems</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n        <span class=\"k\">if</span> <span class=\"n\">nitems</span> <span class=\"o\">==</span> <span class=\"n\">batchsize</span>\n            <span class=\"n\">xs</span> <span class=\"o\">=</span> <span class=\"n\">first</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"n\">batch</span><span class=\"p\">)</span>\n            <span class=\"n\">ys</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n            <span class=\"n\">promises</span> <span class=\"o\">=</span> <span class=\"n\">last</span><span class=\"o\">.</span><span class=\"p\">(</span><span class=\"n\">batch</span><span class=\"p\">)</span>\n            <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">ys</span><span class=\"p\">)</span>\n            <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">batch</span><span class=\"p\">)</span>\n            <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"n\">promise</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"c\"># promise = Channel{TypeOfY}(1)  # if you know the result type of f</span>\n    <span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">promise</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">promise</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span>\n    <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">()</span>\n<span class=\"nd\">@sync</span> <span class=\"k\">try</span>\n    <span class=\"c\"># request = Channel(32)  # maybe better if it's buffered; tuning needed</span>\n    <span class=\"nd\">@async</span> <span class=\"k\">try</span>\n        <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">BAR</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">finally</span>\n        <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n    <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"k\">in</span> <span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ntasks</span>\n        <span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"err\">@</span><span class=\"nd\">@spawn</span> <span class=\"k\">try</span>\n            <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">finally</span>\n            <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">finally</span>\n    <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 238935782,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621124550
    },
    {
        "content": "<p>I haven't done any extensive benchmarks, but here is a more direct implementation of promise than <code>Channel(1)</code> <a href=\"https://github.com/JuliaFolds/FoldsThreads.jl/blob/08329298b73c054e1552f7f4a358e2cdcaf89027/src/utils.jl#L42\">https://github.com/JuliaFolds/FoldsThreads.jl/blob/08329298b73c054e1552f7f4a358e2cdcaf89027/src/utils.jl#L42</a></p>",
        "id": 238935950,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621124771
    },
    {
        "content": "<p>but, as you can see in the above code, the tedious part is more about <em>how</em> to use promises</p>",
        "id": 238935969,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621124804
    },
    {
        "content": "<p>(btw, the above code is totally untested. there can be typos etc.)</p>",
        "id": 238935991,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621124857
    },
    {
        "content": "<p>An interesting point is that it would be a useful pattern to use <code>ntasks</code> larger than <code>nthraeds()</code> or the number of CPUs. The scheduler will suspend the task waiting on <code>take!(promise)</code> and switch to a new task, executing on a shared worker pool on OS threads.</p>",
        "id": 238936174,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621125033
    },
    {
        "content": "<p>(I just noticed that <code>batch_processor</code> might need <code>try</code>-<code>finally</code> around the <code>for</code> loop to close all pending promises, to ensure proper shutdown.)</p>",
        "id": 238936403,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621125252
    },
    {
        "content": "<p>Thank you so much! This was incredibly helpful. I will take a look into Go style programming.</p>",
        "id": 238936791,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621125747
    },
    {
        "content": "<p>You are welcome :) yeah, I think Go style is a good inspiration for doing this kind of things</p>",
        "id": 238937050,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621126083
    },
    {
        "content": "<p>I was just tweaking my above post since I just keep noticing some gotchas :)</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}})</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}</span>\n    <span class=\"n\">batchsize</span> <span class=\"o\">=</span> <span class=\"mi\">32</span>\n    <span class=\"n\">xs</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">promises</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">Promise</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"k\">try</span>\n        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span> <span class=\"k\">in</span> <span class=\"n\">request</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span>\n            <span class=\"n\">nitems</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n            <span class=\"k\">if</span> <span class=\"n\">nitems</span> <span class=\"o\">==</span> <span class=\"n\">batchsize</span>\n                <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">)</span>\n                <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n            <span class=\"k\">end</span>\n        <span class=\"k\">end</span>\n        <span class=\"k\">if</span> <span class=\"o\">!</span><span class=\"n\">isempty</span><span class=\"p\">(</span><span class=\"n\">batch</span><span class=\"p\">)</span>\n            <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">catch</span>\n        <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">close</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">)</span>\n        <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}},</span> <span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">X</span><span class=\"p\">)</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Y</span><span class=\"p\">}</span>\n    <span class=\"n\">promise</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">promise</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">promise</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span>\n    <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">X</span> <span class=\"o\">=</span> <span class=\"n\">Y</span> <span class=\"o\">=</span> <span class=\"kt\">Any</span>  <span class=\"c\"># or more concrete, if known</span>\n<span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}}()</span>\n<span class=\"c\"># request = Channel{Tuple{X,Channel{Y}}}(32)  # maybe better if it's buffered; tuning needed</span>\n<span class=\"nd\">@sync</span> <span class=\"k\">try</span>\n    <span class=\"nd\">@async</span> <span class=\"k\">try</span>\n        <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">BAR</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">finally</span>\n        <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n    <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"k\">in</span> <span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ntasks</span>\n        <span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"err\">@</span><span class=\"nd\">@spawn</span> <span class=\"k\">try</span>\n            <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">catch</span>\n            <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n            <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">finally</span>\n    <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 238937190,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621126215
    },
    {
        "content": "<p>It seems really close to working but is throwing an error message as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"kt\">TaskFailedException</span>\n    <span class=\"n\">nested</span> <span class=\"n\">task</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"kt\">InvalidStateException</span><span class=\"p\">(</span><span class=\"s\">\"Channel is closed.\"</span><span class=\"p\">,</span> <span class=\"ss\">:closed</span><span class=\"p\">)</span>\n    <span class=\"n\">Stacktrace</span><span class=\"o\">:</span>\n     <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"n\">check_channel_state</span>\n       <span class=\"err\">@</span> <span class=\"o\">./</span><span class=\"n\">channels</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">170</span> <span class=\"p\">[</span><span class=\"n\">inlined</span><span class=\"p\">]</span>\n     <span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"n\">put!</span>\n       <span class=\"err\">@</span> <span class=\"o\">./</span><span class=\"n\">channels</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">314</span> <span class=\"p\">[</span><span class=\"n\">inlined</span><span class=\"p\">]</span>\n     <span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">Any</span><span class=\"p\">,</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Any</span><span class=\"p\">}}},</span> <span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">Int64</span><span class=\"p\">)</span>\n       <span class=\"err\">@</span> <span class=\"n\">Main</span> <span class=\"o\">./</span><span class=\"n\">In</span><span class=\"p\">[</span><span class=\"mi\">22</span><span class=\"p\">]</span><span class=\"o\">:</span><span class=\"mi\">35</span>\n     <span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">Any</span><span class=\"p\">,</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Any</span><span class=\"p\">}}})</span>\n       <span class=\"err\">@</span> <span class=\"n\">Main</span> <span class=\"o\">./</span><span class=\"n\">In</span><span class=\"p\">[</span><span class=\"mi\">22</span><span class=\"p\">]</span><span class=\"o\">:</span><span class=\"mi\">41</span>\n     <span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span> <span class=\"p\">(</span><span class=\"o\">::</span><span class=\"kt\">var</span><span class=\"s\">\"#38#40\"</span><span class=\"p\">)()</span>\n       <span class=\"err\">@</span> <span class=\"n\">Main</span> <span class=\"o\">./</span><span class=\"n\">threadingconstructs</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">169</span>\n<span class=\"o\">...</span><span class=\"n\">and</span> <span class=\"mi\">99</span> <span class=\"n\">more</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">Stacktrace</span><span class=\"o\">:</span>\n <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"n\">sync_end</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Any</span><span class=\"p\">})</span>\n   <span class=\"err\">@</span> <span class=\"n\">Base</span> <span class=\"o\">./</span><span class=\"n\">task</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">369</span>\n <span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"n\">top</span><span class=\"o\">-</span><span class=\"n\">level</span> <span class=\"n\">scope</span>\n   <span class=\"err\">@</span> <span class=\"n\">task</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">388</span>\n <span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span> <span class=\"n\">eval</span>\n   <span class=\"err\">@</span> <span class=\"o\">./</span><span class=\"n\">boot</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">360</span> <span class=\"p\">[</span><span class=\"n\">inlined</span><span class=\"p\">]</span>\n <span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span> <span class=\"n\">include_string</span><span class=\"p\">(</span><span class=\"n\">mapexpr</span><span class=\"o\">::</span><span class=\"n\">typeof</span><span class=\"p\">(</span><span class=\"n\">REPL</span><span class=\"o\">.</span><span class=\"n\">softscope</span><span class=\"p\">),</span> <span class=\"n\">mod</span><span class=\"o\">::</span><span class=\"kt\">Module</span><span class=\"p\">,</span> <span class=\"n\">code</span><span class=\"o\">::</span><span class=\"kt\">String</span><span class=\"p\">,</span> <span class=\"n\">filename</span><span class=\"o\">::</span><span class=\"kt\">String</span><span class=\"p\">)</span>\n   <span class=\"err\">@</span> <span class=\"n\">Base</span> <span class=\"o\">./</span><span class=\"n\">loading</span><span class=\"o\">.</span><span class=\"n\">jl</span><span class=\"o\">:</span><span class=\"mi\">1094</span>\n</code></pre></div>\n<p>This is the code I used</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}})</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}</span>\n    <span class=\"n\">batchsize</span> <span class=\"o\">=</span> <span class=\"mi\">32</span>\n\n    <span class=\"c\"># list of images to classify</span>\n    <span class=\"c\"># support 32 elements, but if less, don't give empty elements back</span>\n    <span class=\"n\">xs</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">promises</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">Promise</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n\n    <span class=\"c\"># classify the images in batches</span>\n    <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"k\">try</span>\n        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span> <span class=\"k\">in</span> <span class=\"n\">request</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span>\n            <span class=\"n\">nitems</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n            <span class=\"k\">if</span> <span class=\"n\">nitems</span> <span class=\"o\">==</span> <span class=\"n\">batchsize</span>\n                <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">)</span>\n                <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n            <span class=\"k\">end</span>\n        <span class=\"k\">end</span>\n        <span class=\"c\"># classify any leftovers</span>\n        <span class=\"k\">if</span> <span class=\"o\">!</span><span class=\"n\">isempty</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n            <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">catch</span>\n        <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">close</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">)</span>\n        <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}},</span> <span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">X</span><span class=\"p\">)</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Y</span><span class=\"p\">}</span>\n    <span class=\"n\">promise</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">promise</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">promise</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">)</span>\n    <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n    <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span> <span class=\"o\">==</span> <span class=\"n\">y</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">BAR</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">X</span> <span class=\"o\">=</span> <span class=\"n\">Y</span> <span class=\"o\">=</span> <span class=\"kt\">Any</span>\n<span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}}()</span>   <span class=\"c\"># (32) - maybe better if it's buffered; tuning needed</span>\n<span class=\"n\">ntasks</span> <span class=\"o\">=</span> <span class=\"mi\">100</span>\n\n<span class=\"nd\">@sync</span> <span class=\"k\">try</span>\n    <span class=\"nd\">@async</span> <span class=\"k\">try</span>\n        <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">BAR</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">finally</span>\n        <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n    <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"k\">in</span> <span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ntasks</span>\n        <span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"nd\">@spawn</span> <span class=\"k\">try</span>\n            <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">catch</span>\n            <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n            <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">finally</span>\n    <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 238942304,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621132082
    },
    {
        "content": "<p>can you put three backticks before and after the code?</p>",
        "id": 238942469,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621132280
    },
    {
        "content": "<p>Yes! Sorry, my bad! I was trying to figure out how to format it.</p>",
        "id": 238942477,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621132309
    },
    {
        "content": "<p>It's a bit hard to diagnose since <code>InvalidStateException(\"Channel is closed.\", :closed)</code> is not the cause of the initial error. It's not elegant, but I often put</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">catch</span> <span class=\"n\">err</span>\n    <span class=\"nd\">@error</span> <span class=\"s\">\"Error at XXX\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n</code></pre></div>\n<p>in before each <code>finally</code> block in each <code>@spawn</code> and <code>@async</code>, to figure out the initial cause.</p>",
        "id": 238942890,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621132751
    },
    {
        "content": "<p>This is the error message now:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"n\">┌</span> <span class=\"n\">Error</span><span class=\"o\">:</span> <span class=\"n\">Error</span> <span class=\"k\">in</span> <span class=\"n\">batch</span> <span class=\"n\">processor</span> <span class=\"n\">calls</span> <span class=\"n\">to</span> <span class=\"n\">BAR</span>\n<span class=\"n\">│</span>   <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"kt\">InvalidStateException</span><span class=\"p\">(</span><span class=\"s\">\"Channel is closed.\"</span><span class=\"p\">,</span> <span class=\"ss\">:closed</span><span class=\"p\">),</span> <span class=\"kt\">Union</span><span class=\"p\">{</span><span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">},</span> <span class=\"kt\">Base</span><span class=\"o\">.</span><span class=\"kt\">InterpreterIP</span><span class=\"p\">}[</span><span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000016adffc06</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000016adffce7</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000010a9bf015</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000016adff4e8</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000016adff7ac</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000010a9bf015</span><span class=\"p\">,</span> <span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">Nothing</span><span class=\"p\">}</span> <span class=\"err\">@</span><span class=\"mh\">0x000000010a9da25d</span><span class=\"p\">])</span>\n<span class=\"n\">└</span> <span class=\"err\">@</span> <span class=\"n\">Main</span> <span class=\"n\">In</span><span class=\"p\">[</span><span class=\"mi\">25</span><span class=\"p\">]</span><span class=\"o\">:</span><span class=\"mi\">66</span>\n</code></pre></div>\n<p>Code is below:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}})</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}</span>\n    <span class=\"n\">batchsize</span> <span class=\"o\">=</span> <span class=\"mi\">32</span>\n\n    <span class=\"c\"># list of images to classify</span>\n    <span class=\"c\"># support 32 elements, but if less, don't give empty elements back</span>\n    <span class=\"n\">xs</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">promises</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">Promise</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n\n    <span class=\"c\"># classify the images in batches</span>\n    <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"k\">try</span>\n        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span> <span class=\"k\">in</span> <span class=\"n\">request</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span>\n            <span class=\"n\">nitems</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n            <span class=\"k\">if</span> <span class=\"n\">nitems</span> <span class=\"o\">==</span> <span class=\"n\">batchsize</span>\n                <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">)</span>\n                <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n            <span class=\"k\">end</span>\n        <span class=\"k\">end</span>\n        <span class=\"c\"># classify any leftovers</span>\n        <span class=\"k\">if</span> <span class=\"o\">!</span><span class=\"n\">isempty</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n            <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">catch</span>\n        <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">close</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">)</span>\n        <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}},</span> <span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">X</span><span class=\"p\">)</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Y</span><span class=\"p\">}</span>\n    <span class=\"n\">promise</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">promise</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">promise</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">)</span>\n    <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n    <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span> <span class=\"o\">==</span> <span class=\"n\">y</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">BAR</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">X</span> <span class=\"o\">=</span> <span class=\"n\">Y</span> <span class=\"o\">=</span> <span class=\"kt\">Any</span>\n<span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}}()</span>   <span class=\"c\"># (32) - maybe better if it's buffered; tuning needed</span>\n<span class=\"n\">ntasks</span> <span class=\"o\">=</span> <span class=\"mi\">100</span>\n\n<span class=\"nd\">@sync</span> <span class=\"k\">try</span>\n    <span class=\"nd\">@async</span> <span class=\"k\">try</span>\n        <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">BAR</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">catch</span> <span class=\"n\">err</span>\n        <span class=\"nd\">@error</span> <span class=\"s\">\"Error in batch processor calls to BAR\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n    <span class=\"k\">finally</span>\n        <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n    <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"k\">in</span> <span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ntasks</span>\n        <span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"nd\">@spawn</span> <span class=\"k\">try</span>\n            <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n\n        <span class=\"k\">catch</span> <span class=\"n\">err</span>\n            <span class=\"nd\">@error</span> <span class=\"s\">\"Error in batch processor calls to BAR\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n\n<span class=\"c\">#         catch</span>\n<span class=\"c\">#             close(request)</span>\n<span class=\"c\">#             rethrow()</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n<span class=\"k\">catch</span> <span class=\"n\">err</span>\n    <span class=\"nd\">@error</span> <span class=\"s\">\"Error in sync calls to FOO\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n\n<span class=\"k\">finally</span>\n    <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 238943255,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621133197
    },
    {
        "content": "<p>Ok, so this is tricky. The close exceptions are due to that we are not waiting for the tasks after <code>for _ in 1:ntasks</code>. This itself can be fixed by <code>@sync for _ in 1:ntasks</code>. And it'd let you process the first calls as long as the number is a multiple of <code>batchsize</code>. But the program would deadlock since nobody is closing the request channel.</p>\n<p>Presumably, you have a list of things processed by FOO. So, in principle, FOO can close the request channel inside the last call to <code>batched_call</code> just before <code>take!(promise)</code>.</p>\n<p>But it sounds like a tedious interface to use. I wonder what's the best way to handle this...</p>",
        "id": 238946562,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621136887
    },
    {
        "content": "<p>Since termination is rather tricky, I'd check if a dumb solution like just \"processing <code>batchsize</code> items in each FOO\" works. If FOO processes a much larger number of items than <code>batchsize</code>, I think it'd be much simpler.</p>",
        "id": 238948833,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621139773
    },
    {
        "content": "<p>Do you think asyncmap would be a good fit for this?http://web.mit.edu/julia_v0.6.0/julia/share/doc/julia/html/en/stdlib/parallel.html#Base.asyncmap</p>\n<p>Alternatively, I’m wondering if something as simple as having a channel with max size 32, and then an atomic counter variable, so that whenever the counter hits 32, it reads 32 elements from the channel and processes them. Then, it would free up the channel.</p>",
        "id": 238949903,
        "sender_full_name": "Yash Dalmia",
        "timestamp": 1621141252
    },
    {
        "content": "<p>If you have <code>ncalls</code> calls to FOO (e.g., 100 here), processing <code>(ncalls ÷ 32) * 32</code> elements is already possible with a small tweak to your MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}})</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Promise</span><span class=\"p\">}</span>\n    <span class=\"n\">batchsize</span> <span class=\"o\">=</span> <span class=\"mi\">32</span>\n\n    <span class=\"c\"># list of images to classify</span>\n    <span class=\"c\"># support 32 elements, but if less, don't give empty elements back</span>\n    <span class=\"n\">xs</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n    <span class=\"n\">promises</span> <span class=\"o\">=</span> <span class=\"n\">sizehint!</span><span class=\"p\">(</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">Promise</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">batchsize</span><span class=\"p\">)</span>\n\n    <span class=\"c\"># classify the images in batches</span>\n    <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"k\">try</span>\n        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span> <span class=\"k\">in</span> <span class=\"n\">request</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n            <span class=\"n\">push!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">)</span>\n            <span class=\"n\">nitems</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n            <span class=\"k\">if</span> <span class=\"n\">nitems</span> <span class=\"o\">==</span> <span class=\"n\">batchsize</span>\n                <span class=\"nd\">@info</span> <span class=\"n\">xs</span>\n                <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n                <span class=\"n\">empty!</span><span class=\"p\">(</span><span class=\"n\">promises</span><span class=\"p\">)</span>\n                <span class=\"n\">nitems</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n            <span class=\"k\">end</span>\n        <span class=\"k\">end</span>\n        <span class=\"c\"># classify any leftovers</span>\n        <span class=\"k\">if</span> <span class=\"o\">!</span><span class=\"n\">isempty</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">)</span>\n            <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">put!</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">xs</span><span class=\"p\">))</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">catch</span>\n        <span class=\"n\">foreach</span><span class=\"p\">(</span><span class=\"n\">close</span><span class=\"p\">,</span> <span class=\"n\">promises</span><span class=\"p\">)</span>\n        <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}},</span> <span class=\"n\">x</span><span class=\"o\">::</span><span class=\"kt\">X</span><span class=\"p\">)</span> <span class=\"k\">where</span> <span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Y</span><span class=\"p\">}</span>\n    <span class=\"n\">promise</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n    <span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">promise</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">promise</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n    <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span> <span class=\"o\">==</span> <span class=\"n\">y</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span> <span class=\"n\">BAR</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">X</span> <span class=\"o\">=</span> <span class=\"n\">Y</span> <span class=\"o\">=</span> <span class=\"kt\">Any</span>\n<span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">X</span><span class=\"p\">,</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Y</span><span class=\"p\">}}}()</span>   <span class=\"c\"># (32) - maybe better if it's buffered; tuning needed</span>\n<span class=\"n\">ntasks</span> <span class=\"o\">=</span> <span class=\"mi\">100</span>\n\n\n<span class=\"nd\">@sync</span> <span class=\"k\">try</span>\n    <span class=\"nd\">@async</span> <span class=\"k\">try</span>\n        <span class=\"n\">batch_processor</span><span class=\"p\">(</span><span class=\"n\">BAR</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">catch</span> <span class=\"n\">err</span>\n        <span class=\"nd\">@error</span> <span class=\"s\">\"Error in batch processor calls to BAR\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n        <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n    <span class=\"k\">finally</span>\n        <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n    <span class=\"k\">end</span>\n    <span class=\"nd\">@sync</span> <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"k\">in</span> <span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ntasks</span>\n        <span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"nd\">@spawn</span> <span class=\"k\">try</span>\n            <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n        <span class=\"k\">catch</span> <span class=\"n\">err</span>\n            <span class=\"nd\">@error</span> <span class=\"s\">\"Error in batch processor calls to BAR\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n            <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n\n<span class=\"c\">#         catch</span>\n<span class=\"c\">#             close(request)</span>\n<span class=\"c\">#             rethrow()</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n\n<span class=\"k\">catch</span> <span class=\"n\">err</span>\n    <span class=\"nd\">@error</span> <span class=\"s\">\"Error in sync calls to FOO\"</span> <span class=\"n\">exception</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">,</span> <span class=\"n\">catch_backtrace</span><span class=\"p\">())</span>\n    <span class=\"n\">rethrow</span><span class=\"p\">()</span>\n\n<span class=\"k\">finally</span>\n    <span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 238950421,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621141911
    },
    {
        "content": "<p>but the problem is rather how to end the \"last\" tasks executing FOO</p>",
        "id": 238950500,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621141985
    },
    {
        "content": "<p>I'm not sure if asyncmap is helpful here.</p>",
        "id": 238950717,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621142206
    },
    {
        "content": "<p>Maybe it's possible to write a generic solution if you can re-construct function FOO into the form</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">function</span> <span class=\"n\">FOO</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">input</span><span class=\"p\">)</span>\n   <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"n\">FOO_preprocess</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span>\n   <span class=\"n\">y</span> <span class=\"o\">=</span> <span class=\"n\">batched_call</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span>\n   <span class=\"n\">z</span> <span class=\"o\">=</span> <span class=\"n\">FOO_postprocess</span><span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">input</span><span class=\"p\">)</span>\n   <span class=\"k\">return</span> <span class=\"n\">z</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>Then a higher-order function can take <code>FOO_preprocess</code>, <code>FOO_postprocess</code>, <code>BAR</code>, and <code>batchsize</code> and call them appropriately.</p>",
        "id": 238950786,
        "sender_full_name": "Takafumi Arakaki (tkf)",
        "timestamp": 1621142307
    }
]