[
    {
        "content": "<p>Assume Julia &gt;= v1.10.</p>\n<p>Suppose a file stores a large matrix of floating point numbers in column-major order.</p>\n<p>I can read the file sequentially with</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">m</span>\n<span class=\"w\">    </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</code></pre></div>\n<p>How to leverage multiple threads to read the <code>io</code> in parallel?</p>",
        "id": 558752182,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763759658
    },
    {
        "content": "<p>I think you would be better off optimising your read function and running it on a single thread. <br>\nA float matrix requires no parsing and can be copied directly into memory, so you should be able to hit your drive's maximum speed doing that</p>",
        "id": 558795088,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763797922
    },
    {
        "content": "<p>In your example, it looks like every column is identical. So you can read the first column, then use memcpy to fill all the other columns</p>",
        "id": 558795178,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763797991
    },
    {
        "content": "<p>I simplified the actual code. I need to do some basic processing, including changing the endianess and converting to a different floating point type.</p>",
        "id": 558796848,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763799636
    },
    {
        "content": "<p>But will try to load everything into a large blob and convert later to the final type to compare the speed.</p>",
        "id": 558796923,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763799692
    },
    {
        "content": "<p>In a more complex example, I would have two channels, let's call them <code>filled</code> and <code>emptied</code>, both with buffers (i..e <code>Vector{UInt8}</code> or similar). One task takes a buffer from <code>emptied</code> and overwrites it with raw, unparsed data from the file, then puts it into <code>filled</code>. Then you have N consumed tasks that takes from <code>filled</code>, parses the content, fills in part of the matrix, then returns the buffer by putting it back into <code>emptied</code></p>",
        "id": 558828390,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763830712
    },
    {
        "content": "<p>Could you please share a MWE with your idea <span class=\"user-mention\" data-user-id=\"272650\">@Jakob Nybo Andersen</span> ?</p>",
        "id": 558828605,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763830882
    },
    {
        "content": "<p>Yeah, here:<br>\nIt's not tested, nor with the requisite error checks, so just for illustration purposes. The actual file reading happens in only one thread, since it's essentially impossible to improve linear IO reading with multiple threads, but it's sped up by making sure the thread that does the IO doesn't need to do anything else, and all the parsing is offloaded to worker tasks</p>\n<div class=\"codehilite\" data-code-language=\"Julia\"><pre><span></span><code><span class=\"c\"># Parse raw bytes from IO and put it into the matrix.</span>\n<span class=\"c\"># This happens on multiple threads concurrently</span>\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">parse_into_matrix!</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">dst</span><span class=\"o\">::</span><span class=\"kt\">Matrix</span><span class=\"p\">{</span><span class=\"kt\">Float64</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"n\">from</span><span class=\"o\">::</span><span class=\"kt\">Int</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">data</span><span class=\"o\">::</span><span class=\"kt\">AbstractVector</span><span class=\"p\">{</span><span class=\"kt\">UInt8</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">n_elem</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">divrem</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"p\">(</span><span class=\"n\">eltype</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">)))</span>\n<span class=\"w\">    </span><span class=\"n\">checkbounds</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"o\">:</span><span class=\"n\">from</span><span class=\"o\">+</span><span class=\"n\">n_elem</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">GC</span><span class=\"o\">.</span><span class=\"nd\">@preserve</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">begin</span>\n<span class=\"w\">        </span><span class=\"n\">unsafe_copyto!</span><span class=\"p\">(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"kt\">Ptr</span><span class=\"p\">{</span><span class=\"kt\">eltype</span><span class=\"p\">(</span><span class=\"kt\">dst</span><span class=\"p\">)}(</span><span class=\"n\">pointer</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">n_elem</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">dst</span>\n<span class=\"k\">end</span>\n\n<span class=\"c\"># Each worker tasks runs this function</span>\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">worker_loop</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">matrix</span><span class=\"o\">::</span><span class=\"kt\">Matrix</span><span class=\"p\">{</span><span class=\"kt\">Float64</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"n\">filled</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">UInt8</span><span class=\"p\">}},</span><span class=\"w\"> </span><span class=\"kt\">Int</span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"n\">emptied</span><span class=\"o\">::</span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">UInt8</span><span class=\"p\">}},</span>\n<span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">vector</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">filled</span>\n<span class=\"w\">        </span><span class=\"n\">parse_into_matrix!</span><span class=\"p\">(</span><span class=\"n\">matrix</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vector</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">emptied</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vector</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"o\">::</span><span class=\"kt\">IO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"o\">::</span><span class=\"kt\">Int</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">matrix</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">Matrix</span><span class=\"p\">{</span><span class=\"kt\">Float64</span><span class=\"p\">}(</span><span class=\"nb\">undef</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">filled</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Tuple</span><span class=\"p\">{</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">UInt8</span><span class=\"p\">}},</span><span class=\"w\"> </span><span class=\"kt\">Int</span><span class=\"p\">}(</span><span class=\"nb\">Inf</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">emptied</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">Channel</span><span class=\"p\">{</span><span class=\"kt\">Vector</span><span class=\"p\">{</span><span class=\"kt\">UInt8</span><span class=\"p\">}}(</span><span class=\"nb\">Inf</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"c\"># Initialize worker tasks</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">tasks</span>\n<span class=\"w\">        </span><span class=\"n\">Threads</span><span class=\"o\">.</span><span class=\"nd\">@spawn</span><span class=\"w\"> </span><span class=\"n\">worker_loop</span><span class=\"p\">(</span><span class=\"n\">matrix</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">emptied</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"c\"># Initialize buffers used by both main and worker tasks</span>\n<span class=\"w\">    </span><span class=\"n\">lock</span><span class=\"p\">(</span><span class=\"n\">emptied</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">            </span><span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">emptied</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">UInt8</span><span class=\"p\">[])</span>\n<span class=\"w\">        </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"c\"># Read data in main task, then ship to worker tasks</span>\n<span class=\"w\">    </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">eof</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">take!</span><span class=\"p\">(</span><span class=\"n\">emptied</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">resize!</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"n\">resize!</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">readbytes!</span><span class=\"p\">(</span><span class=\"n\">io</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"n\">put!</span><span class=\"p\">(</span><span class=\"n\">filled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"n\">div</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">Float64</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"k\">end</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">matrix</span>\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 558831693,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763833674
    },
    {
        "content": "<p>Wow, that is too low-level compared to what I had in mind <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 558832119,
        "sender_full_name": "Júlio Hoffimann",
        "timestamp": 1763834097
    },
    {
        "content": "<p>Yeah, multithreading IO is pretty difficult</p>",
        "id": 558832613,
        "sender_full_name": "Jakob Nybo Andersen",
        "timestamp": 1763834548
    }
]