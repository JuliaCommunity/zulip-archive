---
layout: archive
title: Zulip Chat Archive
permalink: /stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html
---

<h2>Stream: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html">Understanding Type Instability</a></h3>

<hr>

<base href="https://julialang.zulipchat.com">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="242564923"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242564923" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242564923">(Jun 14 2021 at 08:12)</a>:</h4>
<p>It's time to get my code type stable and I'm wondering whats going on in this snippet:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>
<p>this part gives me the following code_warntype</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="mi">9</span> <span class="n">┄─</span> <span class="o">%</span><span class="mi">75</span>  <span class="o">=</span> <span class="o">!</span><span class="n">convex</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">└───</span>        <span class="n">goto</span> <span class="c">#39 if not %75</span>
<span class="mi">10</span> <span class="n">─</span>        <span class="p">(</span><span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">79</span>  <span class="o">=</span> <span class="n">ConvexDamage</span><span class="o">.</span><span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>           <span class="n">Core</span><span class="o">.</span><span class="n">setfield!</span><span class="p">(</span><span class="n">ξ</span><span class="nd">@_15</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">,</span> <span class="o">%</span><span class="mi">79</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">81</span>  <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">isdefined</span><span class="p">(</span><span class="n">ξ</span><span class="nd">@_15</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">└───</span>        <span class="n">goto</span> <span class="c">#12 if not %81</span>
<span class="mi">11</span> <span class="n">─</span>        <span class="n">goto</span> <span class="c">#13</span>
<span class="mi">12</span> <span class="n">─</span>        <span class="n">Core</span><span class="o">.</span><span class="n">NewvarNode</span><span class="p">(</span><span class="o">:</span><span class="p">(</span><span class="n">ξ</span><span class="nd">@_28</span><span class="p">))</span>
<span class="n">└───</span>        <span class="n">ξ</span><span class="nd">@_28</span>
<span class="mi">13</span> <span class="n">┄</span> <span class="o">%</span><span class="mi">86</span>  <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="n">ξ</span><span class="nd">@_15</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">87</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="o">%</span><span class="mi">86</span><span class="p">)</span><span class="o">::</span><span class="kt">Any</span>
</code></pre></div>
<p>Now I'm wondering, why <code>Core.getfield(ξ@_15, :contents)</code> is of type <code>::Any</code> if <code>ξ</code> is correctly interferred to a Float64 before?</p>



<a name="242565297"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565297" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565297">(Jun 14 2021 at 08:16)</a>:</h4>
<p>Is it a part of a function? Or all of it is defined in global space?</p>



<a name="242565445"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565445" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565445">(Jun 14 2021 at 08:18)</a>:</h4>
<p>Maybe somewhere else <code>ξ</code> is changed to a different type.</p>



<a name="242565516"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565516" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565516">(Jun 14 2021 at 08:19)</a>:</h4>
<p>Also, what's that <code>Core.isdefined</code> doing in there?</p>



<a name="242565547"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565547" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565547">(Jun 14 2021 at 08:19)</a>:</h4>
<p>Everything is inside a function</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>
<p>The first <code> ξ</code> assignment is interfered to a Float64 as well</p>



<a name="242565612"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565612" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565612">(Jun 14 2021 at 08:20)</a>:</h4>
<p>I think <code>Core.isdefined</code> is related to the upper assignment in the sense of checking if it's already assigned, but I'm not sure.</p>



<a name="242565719"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565719" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565719">(Jun 14 2021 at 08:21)</a>:</h4>
<p>this is the code_warntype of the upper part related to xi </p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">│</span>    <span class="o">%</span><span class="mi">47</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">48</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F¯</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">49</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">47</span> <span class="o">-</span> <span class="o">%</span><span class="mi">48</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">50</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F⁺</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">51</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F¯</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">52</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">50</span> <span class="o">-</span> <span class="o">%</span><span class="mi">51</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">53</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">49</span> <span class="o">/</span> <span class="o">%</span><span class="mi">52</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>           <span class="n">Core</span><span class="o">.</span><span class="n">setfield!</span><span class="p">(</span><span class="n">ξ</span><span class="nd">@_15</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">,</span> <span class="o">%</span><span class="mi">53</span><span class="p">)</span>
</code></pre></div>



<a name="242565845"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565845" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565845">(Jun 14 2021 at 08:22)</a>:</h4>
<p>Ah, I see, so xi is  getting <code>Core.Box</code>ed</p>



<a name="242565923"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565923" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565923">(Jun 14 2021 at 08:23)</a>:</h4>
<p>You could try a manual <code>local xi::Float64</code> (or whatever type it should have) before the first condition</p>



<a name="242565925"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565925" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565925">(Jun 14 2021 at 08:23)</a>:</h4>
<p>What is <code>Core.Box</code> ? And more importantly how can I get rid of it :D</p>



<a name="242565934"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242565934" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242565934">(Jun 14 2021 at 08:23)</a>:</h4>
<p>ah ok, let me try</p>



<a name="242566062"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242566062" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242566062">(Jun 14 2021 at 08:24)</a>:</h4>
<p>And it might also help to rewrite that to an <code>if else</code> block; I'm not sure if Julia can optimize a <code>if cond</code>/<code>if !cond</code> block the same way</p>



<a name="242566905"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242566905" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242566905">(Jun 14 2021 at 08:33)</a>:</h4>
<p>Do you meant something like this ? </p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">local</span> <span class="n">ξ</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>
<p>This is still <code>Core.Box</code> according to @code_warntype</p>



<a name="242568215"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242568215" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242568215">(Jun 14 2021 at 08:47)</a>:</h4>
<p>Outcommenting the first assignment should also fix it, shouldn't it? Unfortunately, it doesn't</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c">#ξ = (F[1] - F¯[1]) / (F⁺[1] - F¯[1])</span>
        <span class="c">#d = (F⁺[1] - F¯[1]) / F[1]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>



<a name="242576243"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242576243" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242576243">(Jun 14 2021 at 10:12)</a>:</h4>
<p>no, I meant something like </p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>
    <span class="k">local</span> <span class="n">ξ</span><span class="o">::</span><span class="kt">Float64</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>



<a name="242576682"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242576682" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242576682">(Jun 14 2021 at 10:17)</a>:</h4>
<p>or just <code>ξ = 0.0</code>, I guess</p>



<a name="242576701"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242576701" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242576701">(Jun 14 2021 at 10:17)</a>:</h4>
<p>also, disregard that comment about using an <code>if</code>/<code>else</code> block, I didn't read your code correctly the first time</p>



<a name="242578587"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242578587" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242578587">(Jun 14 2021 at 10:39)</a>:</h4>
<p>Doing so:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>
    <span class="k">local</span> <span class="n">ξ</span><span class="o">::</span><span class="kt">Float64</span>
    <span class="k">local</span> <span class="n">d</span><span class="o">::</span><span class="kt">Float64</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
</code></pre></div>
<p>fixes pretty much all propagated type instabilities, however the first xi and d statement are now a <code>Core.Box</code> (see <code>%54</code> and <code>%63</code>)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="mi">5</span> <span class="n">──</span> <span class="o">%</span><span class="mi">38</span>  <span class="o">=</span> <span class="n">ConvexDamage</span><span class="o">.</span><span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span><span class="o">::</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span> <span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">}}</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">39</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">indexed_iterate</span><span class="p">(</span><span class="o">%</span><span class="mi">38</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">PartialStruct</span><span class="p">(</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span> <span class="kt">Int64</span><span class="p">},</span> <span class="kt">Any</span><span class="p">[</span><span class="kt">Float64</span><span class="p">,</span> <span class="n">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">W_min</span> <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="o">%</span><span class="mi">39</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">│</span>           <span class="p">(</span><span class="nd">@_9</span> <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="o">%</span><span class="mi">39</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">42</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">indexed_iterate</span><span class="p">(</span><span class="o">%</span><span class="mi">38</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nd">@_9</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">PartialStruct</span><span class="p">(</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="kt">Int64</span><span class="p">},</span> <span class="kt">Any</span><span class="p">[</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">F⁺</span> <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="o">%</span><span class="mi">42</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">│</span>           <span class="p">(</span><span class="nd">@_9</span> <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="o">%</span><span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">45</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">indexed_iterate</span><span class="p">(</span><span class="o">%</span><span class="mi">38</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nd">@_9</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">PartialStruct</span><span class="p">(</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="kt">Int64</span><span class="p">},</span> <span class="kt">Any</span><span class="p">[</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">F¯</span> <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="o">%</span><span class="mi">45</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">47</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">48</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F¯</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">49</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">47</span> <span class="o">-</span> <span class="o">%</span><span class="mi">48</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">50</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F⁺</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">51</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F¯</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">52</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">50</span> <span class="o">-</span> <span class="o">%</span><span class="mi">51</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">53</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">49</span> <span class="o">/</span> <span class="o">%</span><span class="mi">52</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">54</span>  <span class="o">=</span> <span class="n">ξ</span><span class="nd">@_11</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Box</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">55</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ConvexDamage</span><span class="o">.</span><span class="kt">Float64</span><span class="p">,</span> <span class="o">%</span><span class="mi">53</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">56</span>  <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">typeassert</span><span class="p">(</span><span class="o">%</span><span class="mi">55</span><span class="p">,</span> <span class="n">ConvexDamage</span><span class="o">.</span><span class="kt">Float64</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>           <span class="n">Core</span><span class="o">.</span><span class="n">setfield!</span><span class="p">(</span><span class="o">%</span><span class="mi">54</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">,</span> <span class="o">%</span><span class="mi">56</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">58</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F⁺</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">59</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F¯</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">60</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">58</span> <span class="o">-</span> <span class="o">%</span><span class="mi">59</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">61</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">62</span>  <span class="o">=</span> <span class="p">(</span><span class="o">%</span><span class="mi">60</span> <span class="o">/</span> <span class="o">%</span><span class="mi">61</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">63</span>  <span class="o">=</span> <span class="n">d</span><span class="nd">@_10</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Box</span>
</code></pre></div>
<p>which corresponds to these lines</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<p>Sorry for asking now several times, but I don't really understand what's going on. I would understand the compiler complains if the operation before would yield <code>Any</code> or something else, but code_warntype explicitely says it's Float64, so I dont' really get it</p>



<a name="242580308"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242580308" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242580308">(Jun 14 2021 at 10:58)</a>:</h4>
<p>Did you try initializing xi and d to e.g. <code>0.0</code>? Also, maybe try a type annotation for the re-assignments</p>



<a name="242580736"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242580736" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242580736">(Jun 14 2021 at 11:02)</a>:</h4>
<p>If I try the initialization with <code>0.0</code> i get already at initialization <code>Core.Box</code></p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">│</span>    <span class="o">%</span><span class="mi">24</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:relaxed</span><span class="p">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">└───</span>        <span class="n">goto</span> <span class="c">#3 if not %24</span>
<span class="mi">2</span> <span class="n">──</span>        <span class="p">(</span><span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
<span class="n">└───</span>        <span class="n">goto</span> <span class="c">#4</span>
<span class="mi">3</span> <span class="n">──</span>        <span class="p">(</span><span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
<span class="mi">4</span> <span class="n">┄─</span>        <span class="p">(</span><span class="n">W_min</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:W_min</span><span class="p">))</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">W</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:W</span><span class="p">))</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">31</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:damage⁺</span><span class="p">)</span><span class="o">::</span><span class="kt">ConvexDamage</span><span class="o">.</span><span class="kt">Damage</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">32</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="o">%</span><span class="mi">31</span><span class="p">,</span> <span class="ss">:Fₖ</span><span class="p">)</span><span class="o">::</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">33</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:damage¯</span><span class="p">)</span><span class="o">::</span><span class="kt">ConvexDamage</span><span class="o">.</span><span class="kt">Damage</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">34</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">getproperty</span><span class="p">(</span><span class="o">%</span><span class="mi">33</span><span class="p">,</span> <span class="ss">:Fₖ</span><span class="p">)</span><span class="o">::</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">F⁺</span> <span class="o">=</span> <span class="o">%</span><span class="mi">32</span><span class="p">)</span>
<span class="n">│</span>           <span class="p">(</span><span class="n">F¯</span> <span class="o">=</span> <span class="o">%</span><span class="mi">34</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">37</span>  <span class="o">=</span> <span class="n">ξ</span><span class="nd">@_15</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Box</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">38</span>  <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ConvexDamage</span><span class="o">.</span><span class="kt">Float64</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">39</span>  <span class="o">=</span> <span class="n">Core</span><span class="o">.</span><span class="n">typeassert</span><span class="p">(</span><span class="o">%</span><span class="mi">38</span><span class="p">,</span> <span class="n">ConvexDamage</span><span class="o">.</span><span class="kt">Float64</span><span class="p">)</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">│</span>           <span class="n">Core</span><span class="o">.</span><span class="n">setfield!</span><span class="p">(</span><span class="o">%</span><span class="mi">37</span><span class="p">,</span> <span class="ss">:contents</span><span class="p">,</span> <span class="o">%</span><span class="mi">39</span><span class="p">)</span>
<span class="n">│</span>    <span class="o">%</span><span class="mi">41</span>  <span class="o">=</span> <span class="n">d</span><span class="nd">@_14</span><span class="o">::</span><span class="kt">Core</span><span class="o">.</span><span class="n">Box</span>
</code></pre></div>
<p>corresponds to the code part above the first <code>if</code> statement</p>



<a name="242580758"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242580758" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242580758">(Jun 14 2021 at 11:02)</a>:</h4>
<p>Just out of curiousity, if you use <code>ξ2</code> instead of <code>ξ</code> (and comment out everything after conditions), will it still be a <code>Box</code>?<br>
I mean, something like</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>
    <span class="k">local</span> <span class="n">ξ</span><span class="o">::</span><span class="kt">Float64</span>
    <span class="k">local</span> <span class="n">d</span><span class="o">::</span><span class="kt">Float64</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ2</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ2</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Note, that function ends here (there is no continuation, which can introduce additional difficulties for compiler).</p>



<a name="242580893"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242580893" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242580893">(Jun 14 2021 at 11:04)</a>:</h4>
<p>In general this is the full function, if it matters:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>
    <span class="n">ξ</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">ξ</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">d</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ξ</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mf">0.0</span>
        <span class="c">#P, 𝔸, ψ⁺, ψ¯ = homogenized_derivatives(ξ, d, F, material, state) FIXME</span>
        <span class="n">𝔸</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">Tensors</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span>
                <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">W_homogenized</span><span class="p">(</span><span class="n">ξ</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
                <span class="n">F</span><span class="p">,</span>
                <span class="ss">:all</span><span class="p">)</span>
        <span class="n">ψ⁺</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F⁺</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">ψ¯</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F¯</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="n">symmetric</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">*</span> <span class="n">P</span> <span class="o">⋅</span> <span class="n">F</span><span class="o">'</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_homogenized</span><span class="p">(</span><span class="n">ξ</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">unrelaxed</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">ψₖ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
        <span class="n">phase⁺</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ⁺</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ⁺</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F⁺</span><span class="p">)</span>
        <span class="n">phase¯</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ¯</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ¯</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F¯</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c">#𝔸, P, ψ = strain_energy_derivatives(F, material, state)</span>
        <span class="n">𝔸</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">Tensors</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">),</span> <span class="n">F</span><span class="p">,</span> <span class="ss">:all</span><span class="p">)</span>
        <span class="n">ψ</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="n">symmetric</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">P</span> <span class="o">⋅</span> <span class="n">F</span><span class="o">'</span><span class="p">)</span>
        <span class="n">ξ</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">ξₖ</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dₖ</span>
        <span class="n">unrelaxed</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
        <span class="n">phase⁺</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">))</span>
        <span class="n">phase¯</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">newstate</span> <span class="o">=</span> <span class="n">RelaxedDamageState</span><span class="p">(</span><span class="n">unrelaxed</span><span class="p">,</span><span class="n">phase⁺</span><span class="p">,</span><span class="n">phase¯</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span> <span class="n">ξ</span><span class="p">,</span><span class="n">d</span><span class="p">,</span> <span class="n">W_min</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">convex</span><span class="p">,</span> <span class="n">relaxed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">𝔸</span><span class="p">,</span> <span class="n">newstate</span>
<span class="k">end</span>
</code></pre></div>



<a name="242580961"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242580961" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242580961">(Jun 14 2021 at 11:04)</a>:</h4>
<p>I'll try it with a second xi variable</p>



<a name="242581126"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581126" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581126">(Jun 14 2021 at 11:06)</a>:</h4>
<p>I feel like you'd need to annotate all xi assignments if you want to get rid of the box</p>



<a name="242581148"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581148" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581148">(Jun 14 2021 at 11:06)</a>:</h4>
<p>but my intuition for that isn't great either apart from closures <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="242581348"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581348" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581348">(Jun 14 2021 at 11:08)</a>:</h4>
<p>Oh, there is another  <code>ξ</code> in <code>ξ = state.ξₖ</code>.</p>



<a name="242581355"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581355" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581355">(Jun 14 2021 at 11:08)</a>:</h4>
<p>Probably this is where you get type instability.</p>



<a name="242581406"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581406" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581406">(Jun 14 2021 at 11:09)</a>:</h4>
<p>If I annotate multiple ones I get multiple type annotation error, am I doing it wrong by just writing <code>ξ::Float64 = ...</code> in front of each assignment?</p>



<a name="242581437"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581437" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581437">(Jun 14 2021 at 11:09)</a>:</h4>
<p>ah, yeah, you'd want to annotate the rhs, not the lhs</p>



<a name="242581447"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581447" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581447">(Jun 14 2021 at 11:09)</a>:</h4>
<p>but <code>state.ξₖ</code> is a Float64. That's exactly the point that I don't get</p>



<a name="242581518"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581518" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581518">(Jun 14 2021 at 11:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="208845">Sebastian Pfitzner</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Understanding.20Type.20Instability/near/242581437">said</a>:</p>
<blockquote>
<p>ah, yeah, you'd want to annotate the rhs, not the lhs</p>
</blockquote>
<p>so e.g. <code>volumefraction(...)::Float64</code>?</p>



<a name="242581753"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581753" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Ekre <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581753">(Jun 14 2021 at 11:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276387">Max Köhler</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Understanding.20Type.20Instability/near/242581447">said</a>:</p>
<blockquote>
<p>but <code>state.ξₖ</code> is a Float64. That's exactly the point that I don't get</p>
</blockquote>
<p>Just to make sure, that field is strongly typed in the struct definition?</p>



<a name="242581782"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242581782" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242581782">(Jun 14 2021 at 11:13)</a>:</h4>
<p>yes its</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Base</span><span class="o">.</span><span class="nd">@kwdef</span> <span class="k">struct</span> <span class="kt">RelaxedDamageState</span><span class="p">{</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">M</span><span class="p">,</span><span class="kt">N</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="kt">MaterialState</span>
    <span class="n">damage</span><span class="o">::</span><span class="kt">Damage</span><span class="p">{</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">M</span><span class="p">}</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">()</span>
    <span class="n">damage⁺</span><span class="o">::</span><span class="kt">Damage</span><span class="p">{</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">M</span><span class="p">}</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">()</span>
    <span class="n">damage¯</span><span class="o">::</span><span class="kt">Damage</span><span class="p">{</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">M</span><span class="p">}</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">()</span>
    <span class="n">P</span><span class="o">::</span><span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">M</span><span class="p">}</span> <span class="o">=</span> <span class="kt">Tensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">}((</span><span class="mf">0.0</span><span class="p">,))</span>
    <span class="n">σ</span><span class="o">::</span><span class="kt">SymmetricTensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="kt">dim</span><span class="p">,</span><span class="kt">T</span><span class="p">,</span><span class="kt">N</span><span class="p">}</span> <span class="o">=</span> <span class="kt">SymmetricTensor</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">}((</span><span class="mf">0.0</span><span class="p">,))</span>
    <span class="n">ξₖ</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dₖ</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">W_min</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">W</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">convex</span><span class="o">::</span><span class="kt">Bool</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">relaxed</span><span class="o">::</span><span class="kt">Bool</span> <span class="o">=</span> <span class="nb">false</span>
<span class="k">end</span>
</code></pre></div>



<a name="242582596"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242582596" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242582596">(Jun 14 2021 at 11:22)</a>:</h4>
<p>This is now  a type stable version, but I still don't understand why. It's pretty much your suggestion <span class="user-mention" data-user-id="272771">@Andrey Oskin</span></p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">constitutive_driver</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="o">::</span><span class="kt">RelaxedDamage</span><span class="p">,</span> <span class="n">state</span><span class="o">::</span><span class="kt">RelaxedDamageState</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">relaxed</span> <span class="o">?</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">:</span> <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">W_min</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W_min</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">W</span>
    <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">Fₖ</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">Fₖ</span>
    <span class="c">#local ξ::Float64</span>
    <span class="c">#local d::Float64</span>
    <span class="n">ξ_old</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">ξₖ</span>
    <span class="n">d_old</span><span class="o">::</span><span class="kt">Float64</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dₖ</span>

    <span class="k">if</span> <span class="n">convex</span>
        <span class="n">W_min</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span> <span class="n">F¯</span> <span class="o">=</span> <span class="n">convexify</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c">#ξ_new = (F[1] - F¯[1]) / (F⁺[1] - F¯[1])::Float64</span>
        <span class="c">#d_new = (F⁺[1] - F¯[1]) / F[1]::Float64</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span>  <span class="n">W</span> <span class="o">&lt;</span> <span class="n">W_min</span> <span class="o">||</span> <span class="n">isapprox</span><span class="p">(</span><span class="n">W_min</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">convex</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ξ_new</span> <span class="o">=</span> <span class="n">volumefraction</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F⁺</span><span class="p">,</span><span class="n">F¯</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
        <span class="k">if</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ξ_new</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="k">else</span>
            <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="k">end</span>
        <span class="n">d_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">ξ_new</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">(</span><span class="n">F⁺</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">F¯</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">::</span><span class="kt">Float64</span>
        <span class="c">#P, 𝔸, ψ⁺, ψ¯ = homogenized_derivatives(ξ, d, F, material, state) FIXME</span>
        <span class="n">𝔸</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">Tensors</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span>
                <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">W_homogenized</span><span class="p">(</span><span class="n">ξ_new</span><span class="p">,</span> <span class="n">d_new</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
                <span class="n">F</span><span class="p">,</span>
                <span class="ss">:all</span><span class="p">)</span>
        <span class="n">ψ⁺</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F⁺</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">ψ¯</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F¯</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="n">symmetric</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">*</span> <span class="n">P</span> <span class="o">⋅</span> <span class="n">F</span><span class="o">'</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W_homogenized</span><span class="p">(</span><span class="n">ξ_new</span><span class="p">,</span> <span class="n">d_new</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">unrelaxed</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">ψₖ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
        <span class="n">phase⁺</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ⁺</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage⁺</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ⁺</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F⁺</span><span class="p">)</span>
        <span class="n">phase¯</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ¯</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage¯</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ¯</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F¯</span><span class="p">)</span>
        <span class="n">newstate</span> <span class="o">=</span> <span class="n">RelaxedDamageState</span><span class="p">(</span><span class="n">unrelaxed</span><span class="p">,</span><span class="n">phase⁺</span><span class="p">,</span><span class="n">phase¯</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span> <span class="n">ξ_new</span><span class="p">,</span><span class="n">d_new</span><span class="p">,</span> <span class="n">W_min</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">convex</span><span class="p">,</span> <span class="n">relaxed</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="c">#𝔸, P, ψ = strain_energy_derivatives(F, material, state)</span>
        <span class="n">𝔸</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">Tensors</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="n">W_energy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="p">),</span> <span class="n">F</span><span class="p">,</span> <span class="ss">:all</span><span class="p">)</span>
        <span class="n">ψ</span> <span class="o">=</span> <span class="n">Ψ</span><span class="p">(</span><span class="n">tdot</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">material</span><span class="o">.</span><span class="n">base_material</span><span class="p">)</span>
        <span class="n">convex</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="n">symmetric</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">P</span> <span class="o">⋅</span> <span class="n">F</span><span class="o">'</span><span class="p">)</span>
        <span class="c">#ξ = copy(state.ξₖ)::Float64</span>
        <span class="c">#d = copy(state.dₖ)::Float64</span>
        <span class="n">unrelaxed</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">),</span> <span class="n">Fₖ</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
        <span class="n">phase⁺</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">))</span>
        <span class="n">phase¯</span> <span class="o">=</span> <span class="n">Damage</span><span class="p">(</span><span class="n">ψₖ</span> <span class="o">=</span> <span class="n">ψ</span><span class="p">,</span> <span class="n">βₖ</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">damage</span><span class="o">.</span><span class="n">βₖ</span><span class="p">,</span> <span class="n">ψ</span><span class="p">))</span>
        <span class="n">newstate</span> <span class="o">=</span> <span class="n">RelaxedDamageState</span><span class="p">(</span><span class="n">unrelaxed</span><span class="p">,</span><span class="n">phase⁺</span><span class="p">,</span><span class="n">phase¯</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span> <span class="n">ξ_old</span><span class="p">,</span><span class="n">d_old</span><span class="p">,</span> <span class="n">W_min</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">convex</span><span class="p">,</span> <span class="n">relaxed</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">𝔸</span><span class="p">,</span> <span class="n">newstate</span>
<span class="k">end</span>
</code></pre></div>



<a name="242582770"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242582770" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242582770">(Jun 14 2021 at 11:25)</a>:</h4>
<p>Hmm, it shouldn't work, since if <code>convex</code> is  true, <code>newstate</code> is not defined.</p>



<a name="242582806"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242582806" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242582806">(Jun 14 2021 at 11:25)</a>:</h4>
<p>Really? Both branches in the if-else statement define <code>newstate</code></p>



<a name="242583431"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242583431" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242583431">(Jun 14 2021 at 11:33)</a>:</h4>
<p>The type annotations are actually not needed in the above example. Unfortunately, I can't get a version working, which uses the <code>local</code> statement with type annotations. If I try to do it, I directly get a <code>Core.Box</code> at initialization.</p>



<a name="242584619"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242584619" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrey Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242584619">(Jun 14 2021 at 11:47)</a>:</h4>
<p>Ah, I see, yes, you are right. Yes, everything is defined properly in all branches.</p>



<a name="242588090"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242588090" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242588090">(Jun 14 2021 at 12:23)</a>:</h4>
<p>So I achieved now somewhat what I wanted, i.e. a type stable version but I still don't understand why this fixes the <code>Core.Box</code>problem. I have some intuition what is meant by that, but in this particular case I cannot see the logic behind it. Other than that and quite a related question for a different function:</p>
<p>Is there a type stable version of <code>findfirst</code> or should I go for a small custom function?</p>



<a name="242588202"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242588202" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Ekre <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242588202">(Jun 14 2021 at 12:24)</a>:</h4>
<p>Just make sure to properly handle the <code>nothing</code> case and there shouldn't be a problem.</p>



<a name="242588322"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242588322" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242588322">(Jun 14 2021 at 12:25)</a>:</h4>
<p>As far as I understood, GPUCompiler will complain about any type instability, but maybe the <code>Union</code> with nothing is an exception</p>



<a name="242588470"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242588470" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Ekre <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242588470">(Jun 14 2021 at 12:26)</a>:</h4>
<p>I mean, if you do something like</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">idx</span> <span class="o">=</span> <span class="n">findfirst</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">===</span> <span class="nb">nothing</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c"># something with idx</span>
</code></pre></div>
<p>isn't that okay?</p>



<a name="242589009"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Understanding%20Type%20Instability/near/242589009" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Köhler <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Understanding.20Type.20Instability.html#242589009">(Jun 14 2021 at 12:31)</a>:</h4>
<p>ah ok nvm, <code>findfirst</code> seems to have it's own dispatch for gpuarrays, so should be okay I guess</p>



{% endraw %}

<hr><p>Last updated: Jun 25 2021 at 11:01 UTC</p>