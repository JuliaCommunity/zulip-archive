<html>
<head><meta charset="utf-8"><title>Task and Channel for Batch Scheduling · helpdesk (published) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html">Task and Channel for Batch Scheduling</a></h3>

<hr>

<base href="https://julialang.zulipchat.com">

<head><link href="https://juliacommunity.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="238931513"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238931513" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238931513">(May 15 2021 at 23:02)</a>:</h4>
<p>Can anyone help me with a batch scheduling problem? </p>
<p>Description: <br>
I have a function FOO that I want to run on multiple threads at once. While FOO is running, it will occasionally call another function BAR with an argument unique to each thread that FOO is running on. I want BAR to batch process whatever FOO passes to it (say 32 at a time), and return the values to each unique thread that is running FOO. Is there a way to do this using the Task Library or Channel Library?</p>
<p>If the description of foo and bar is too abstract, I essentially have threads running that each want to classify images, but I want to batch the images before sending them to the GPU to be classified.</p>



<a name="238932342"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238932342" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238932342">(May 15 2021 at 23:16)</a>:</h4>
<p>Does FOO have to wait for BAR? If so, what's different from a simple blocking call after accumulating 32 elements?</p>
<p>But, since you use GPU, maybe you want to pipeline several calls of BAR from each FOO?</p>



<a name="238932544"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238932544" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238932544">(May 15 2021 at 23:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="297129">Takafumi Arakaki (tkf)</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Task.20and.20Channel.20for.20Batch.20Scheduling/near/238932342">said</a>:</p>
<blockquote>
<p>Does FOO have to wait for BAR? If so, what's different from a simple blocking call after accumulating 32 elements?</p>
<p>But, since you use GPU, maybe you want to pipeline several calls of BAR from each FOO?</p>
</blockquote>
<p>Yes, FOO needs to wait for BAR before it can continue. I essentially am just trying to figure out how to batch the calls, but ensure that each output from BAR goes to the exact FOO that called it. For example, I thought one way to do this might be create a tuples of the thread_id and the image, classify 32 at a time, and then let the worker threads take their respective images that they put in the channel for classification. But I was interested to know what the best mechanism for this type of idea is.</p>



<a name="238934475"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238934475" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238934475">(May 15 2021 at 23:58)</a>:</h4>
<p>So, are 32 items coming from different tasks executing <code>FOO</code>? i.e., you want to combine 32 calls from different tasks to issue one GPU kernel call?</p>



<a name="238934633"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238934633" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238934633">(May 16 2021 at 00:01)</a>:</h4>
<p>...and want to make sure the result of the call goes back to the correct  <code>FOO</code></p>



<a name="238934941"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238934941" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238934941">(May 16 2021 at 00:06)</a>:</h4>
<p>Yes. Essentially, let’s say the </p>
<p>Thread 1 calls G with arg 1<br>
Thread 2 calls G with arg 2 <br>
Etc etc<br>
Thread n calls G with arg n</p>
<p>I want G (the gpu) to operate on argument 1,2...n in batches of 32 while making sure the result of g on arg1 returns to thread 1, the result of arg2 returns to thread 2, etc.</p>



<a name="238935782"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238935782" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238935782">(May 16 2021 at 00:22)</a>:</h4>
<p>OK, I now understand the question. You essentially need a promise (future). The easiest way to do this in Julia is to use single element "one-shot" <code>Channel</code> (I think Go programmers use it all the time).</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">batch_processor</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">)</span>
    <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="c"># It's better to use two arrays but for now this is an array of 2-tuples :</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">eltype</span><span class="p">(</span><span class="kt">Channel</span><span class="p">)}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="k">in</span> <span class="n">request</span>
        <span class="n">push!</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">nitems</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nitems</span> <span class="o">==</span> <span class="n">batchsize</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">promises</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
            <span class="n">empty!</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># promise = Channel{TypeOfY}(1)  # if you know the result type of f</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">promise</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take!</span><span class="p">(</span><span class="n">promise</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">...</span>
<span class="k">end</span>

<span class="n">request</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">()</span>
<span class="nd">@sync</span> <span class="k">try</span>
    <span class="c"># request = Channel(32)  # maybe better if it's buffered; tuning needed</span>
    <span class="nd">@async</span> <span class="k">try</span>
        <span class="n">batch_processor</span><span class="p">(</span><span class="n">BAR</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">ntasks</span>
        <span class="n">Threads</span><span class="o">.</span><span class="err">@</span><span class="nd">@spawn</span> <span class="k">try</span>
            <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">finally</span>
            <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">finally</span>
    <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>



<a name="238935950"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238935950" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238935950">(May 16 2021 at 00:26)</a>:</h4>
<p>I haven't done any extensive benchmarks, but here is a more direct implementation of promise than <code>Channel(1)</code> <a href="https://github.com/JuliaFolds/FoldsThreads.jl/blob/08329298b73c054e1552f7f4a358e2cdcaf89027/src/utils.jl#L42">https://github.com/JuliaFolds/FoldsThreads.jl/blob/08329298b73c054e1552f7f4a358e2cdcaf89027/src/utils.jl#L42</a></p>



<a name="238935969"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238935969" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238935969">(May 16 2021 at 00:26)</a>:</h4>
<p>but, as you can see in the above code, the tedious part is more about <em>how</em> to use promises</p>



<a name="238935991"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238935991" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238935991">(May 16 2021 at 00:27)</a>:</h4>
<p>(btw, the above code is totally untested. there can be typos etc.)</p>



<a name="238936174"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238936174" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238936174">(May 16 2021 at 00:30)</a>:</h4>
<p>An interesting point is that it would be a useful pattern to use <code>ntasks</code> larger than <code>nthraeds()</code> or the number of CPUs. The scheduler will suspend the task waiting on <code>take!(promise)</code> and switch to a new task, executing on a shared worker pool on OS threads.</p>



<a name="238936403"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238936403" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238936403">(May 16 2021 at 00:34)</a>:</h4>
<p>(I just noticed that <code>batch_processor</code> might need <code>try</code>-<code>finally</code> around the <code>for</code> loop to close all pending promises, to ensure proper shutdown.)</p>



<a name="238936791"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238936791" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238936791">(May 16 2021 at 00:42)</a>:</h4>
<p>Thank you so much! This was incredibly helpful. I will take a look into Go style programming.</p>



<a name="238937050"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238937050" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238937050">(May 16 2021 at 00:48)</a>:</h4>
<p>You are welcome :) yeah, I think Go style is a good inspiration for doing this kind of things</p>



<a name="238937190"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238937190" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238937190">(May 16 2021 at 00:50)</a>:</h4>
<p>I was just tweaking my above post since I just keep noticing some gotchas :)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">batch_processor</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}})</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}</span>
    <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">X</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">promises</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Promise</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">in</span> <span class="n">request</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">promises</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">nitems</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nitems</span> <span class="o">==</span> <span class="n">batchsize</span>
                <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">promises</span><span class="p">)</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">isempty</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">catch</span>
        <span class="n">foreach</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">promises</span><span class="p">)</span>
        <span class="n">rethrow</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}},</span> <span class="n">x</span><span class="o">::</span><span class="kt">X</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Y</span><span class="p">}</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">promise</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take!</span><span class="p">(</span><span class="n">promise</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">...</span>
<span class="k">end</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">=</span> <span class="kt">Any</span>  <span class="c"># or more concrete, if known</span>
<span class="n">request</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}}()</span>
<span class="c"># request = Channel{Tuple{X,Channel{Y}}}(32)  # maybe better if it's buffered; tuning needed</span>
<span class="nd">@sync</span> <span class="k">try</span>
    <span class="nd">@async</span> <span class="k">try</span>
        <span class="n">batch_processor</span><span class="p">(</span><span class="n">BAR</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">ntasks</span>
        <span class="n">Threads</span><span class="o">.</span><span class="err">@</span><span class="nd">@spawn</span> <span class="k">try</span>
            <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">catch</span>
            <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">rethrow</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">finally</span>
    <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>



<a name="238942304"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238942304" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238942304">(May 16 2021 at 02:28)</a>:</h4>
<p>It seems really close to working but is throwing an error message as follows:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="kt">TaskFailedException</span>
    <span class="n">nested</span> <span class="n">task</span> <span class="n">error</span><span class="o">:</span> <span class="kt">InvalidStateException</span><span class="p">(</span><span class="s">"Channel is closed."</span><span class="p">,</span> <span class="ss">:closed</span><span class="p">)</span>
    <span class="n">Stacktrace</span><span class="o">:</span>
     <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">check_channel_state</span>
       <span class="err">@</span> <span class="o">./</span><span class="n">channels</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">170</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
     <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">put!</span>
       <span class="err">@</span> <span class="o">./</span><span class="n">channels</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">314</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
     <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Any</span><span class="p">}}},</span> <span class="n">x</span><span class="o">::</span><span class="kt">Int64</span><span class="p">)</span>
       <span class="err">@</span> <span class="n">Main</span> <span class="o">./</span><span class="n">In</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span><span class="o">:</span><span class="mi">35</span>
     <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Any</span><span class="p">}}})</span>
       <span class="err">@</span> <span class="n">Main</span> <span class="o">./</span><span class="n">In</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span><span class="o">:</span><span class="mi">41</span>
     <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">(</span><span class="o">::</span><span class="kt">var</span><span class="s">"#38#40"</span><span class="p">)()</span>
       <span class="err">@</span> <span class="n">Main</span> <span class="o">./</span><span class="n">threadingconstructs</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">169</span>
<span class="o">...</span><span class="n">and</span> <span class="mi">99</span> <span class="n">more</span> <span class="n">exceptions</span><span class="o">.</span>
</code></pre></div>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Stacktrace</span><span class="o">:</span>
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">sync_end</span><span class="p">(</span><span class="n">c</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Any</span><span class="p">})</span>
   <span class="err">@</span> <span class="n">Base</span> <span class="o">./</span><span class="n">task</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">369</span>
 <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="err">@</span> <span class="n">task</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">388</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">eval</span>
   <span class="err">@</span> <span class="o">./</span><span class="n">boot</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">360</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">include_string</span><span class="p">(</span><span class="n">mapexpr</span><span class="o">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">REPL</span><span class="o">.</span><span class="n">softscope</span><span class="p">),</span> <span class="n">mod</span><span class="o">::</span><span class="kt">Module</span><span class="p">,</span> <span class="n">code</span><span class="o">::</span><span class="kt">String</span><span class="p">,</span> <span class="n">filename</span><span class="o">::</span><span class="kt">String</span><span class="p">)</span>
   <span class="err">@</span> <span class="n">Base</span> <span class="o">./</span><span class="n">loading</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">1094</span>
</code></pre></div>
<p>This is the code I used</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">batch_processor</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}})</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}</span>
    <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c"># list of images to classify</span>
    <span class="c"># support 32 elements, but if less, don't give empty elements back</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">X</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">promises</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Promise</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>

    <span class="c"># classify the images in batches</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">in</span> <span class="n">request</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">promises</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">nitems</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nitems</span> <span class="o">==</span> <span class="n">batchsize</span>
                <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">promises</span><span class="p">)</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="c"># classify any leftovers</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">isempty</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">catch</span>
        <span class="n">foreach</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">promises</span><span class="p">)</span>
        <span class="n">rethrow</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}},</span> <span class="n">x</span><span class="o">::</span><span class="kt">X</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Y</span><span class="p">}</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">promise</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take!</span><span class="p">(</span><span class="n">promise</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">BAR</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
<span class="k">end</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">=</span> <span class="kt">Any</span>
<span class="n">request</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}}()</span>   <span class="c"># (32) - maybe better if it's buffered; tuning needed</span>
<span class="n">ntasks</span> <span class="o">=</span> <span class="mi">100</span>

<span class="nd">@sync</span> <span class="k">try</span>
    <span class="nd">@async</span> <span class="k">try</span>
        <span class="n">batch_processor</span><span class="p">(</span><span class="n">BAR</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">ntasks</span>
        <span class="n">Threads</span><span class="o">.</span><span class="nd">@spawn</span> <span class="k">try</span>
            <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">catch</span>
            <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">rethrow</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">finally</span>
    <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>



<a name="238942469"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238942469" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238942469">(May 16 2021 at 02:31)</a>:</h4>
<p>can you put three backticks before and after the code?</p>



<a name="238942477"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238942477" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238942477">(May 16 2021 at 02:31)</a>:</h4>
<p>Yes! Sorry, my bad! I was trying to figure out how to format it.</p>



<a name="238942890"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238942890" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238942890">(May 16 2021 at 02:39)</a>:</h4>
<p>It's a bit hard to diagnose since <code>InvalidStateException("Channel is closed.", :closed)</code> is not the cause of the initial error. It's not elegant, but I often put</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">catch</span> <span class="n">err</span>
    <span class="nd">@error</span> <span class="s">"Error at XXX"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>
</code></pre></div>
<p>in before each <code>finally</code> block in each <code>@spawn</code> and <code>@async</code>, to figure out the initial cause.</p>



<a name="238943255"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238943255" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238943255">(May 16 2021 at 02:46)</a>:</h4>
<p>This is the error message now:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">┌</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Error</span> <span class="k">in</span> <span class="n">batch</span> <span class="n">processor</span> <span class="n">calls</span> <span class="n">to</span> <span class="n">BAR</span>
<span class="n">│</span>   <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="kt">InvalidStateException</span><span class="p">(</span><span class="s">"Channel is closed."</span><span class="p">,</span> <span class="ss">:closed</span><span class="p">),</span> <span class="kt">Union</span><span class="p">{</span><span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">},</span> <span class="kt">Base</span><span class="o">.</span><span class="kt">InterpreterIP</span><span class="p">}[</span><span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000016adffc06</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000016adffce7</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000010a9bf015</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000016adff4e8</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000016adff7ac</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000010a9bf015</span><span class="p">,</span> <span class="kt">Ptr</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">}</span> <span class="err">@</span><span class="mh">0x000000010a9da25d</span><span class="p">])</span>
<span class="n">└</span> <span class="err">@</span> <span class="n">Main</span> <span class="n">In</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span><span class="o">:</span><span class="mi">66</span>
</code></pre></div>
<p>Code is below:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">batch_processor</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}})</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}</span>
    <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c"># list of images to classify</span>
    <span class="c"># support 32 elements, but if less, don't give empty elements back</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">X</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">promises</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Promise</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>

    <span class="c"># classify the images in batches</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">in</span> <span class="n">request</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">promises</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">nitems</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nitems</span> <span class="o">==</span> <span class="n">batchsize</span>
                <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">promises</span><span class="p">)</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="c"># classify any leftovers</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">isempty</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">catch</span>
        <span class="n">foreach</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">promises</span><span class="p">)</span>
        <span class="n">rethrow</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}},</span> <span class="n">x</span><span class="o">::</span><span class="kt">X</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Y</span><span class="p">}</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">promise</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take!</span><span class="p">(</span><span class="n">promise</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">BAR</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
<span class="k">end</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">=</span> <span class="kt">Any</span>
<span class="n">request</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}}()</span>   <span class="c"># (32) - maybe better if it's buffered; tuning needed</span>
<span class="n">ntasks</span> <span class="o">=</span> <span class="mi">100</span>

<span class="nd">@sync</span> <span class="k">try</span>
    <span class="nd">@async</span> <span class="k">try</span>
        <span class="n">batch_processor</span><span class="p">(</span><span class="n">BAR</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">catch</span> <span class="n">err</span>
        <span class="nd">@error</span> <span class="s">"Error in batch processor calls to BAR"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>
    <span class="k">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">ntasks</span>
        <span class="n">Threads</span><span class="o">.</span><span class="nd">@spawn</span> <span class="k">try</span>
            <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">catch</span> <span class="n">err</span>
            <span class="nd">@error</span> <span class="s">"Error in batch processor calls to BAR"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>

<span class="c">#         catch</span>
<span class="c">#             close(request)</span>
<span class="c">#             rethrow()</span>
        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">catch</span> <span class="n">err</span>
    <span class="nd">@error</span> <span class="s">"Error in sync calls to FOO"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>

<span class="k">finally</span>
    <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>



<a name="238946562"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238946562" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238946562">(May 16 2021 at 03:48)</a>:</h4>
<p>Ok, so this is tricky. The close exceptions are due to that we are not waiting for the tasks after <code>for _ in 1:ntasks</code>. This itself can be fixed by <code>@sync for _ in 1:ntasks</code>. And it'd let you process the first calls as long as the number is a multiple of <code>batchsize</code>. But the program would deadlock since nobody is closing the request channel.</p>
<p>Presumably, you have a list of things processed by FOO. So, in principle, FOO can close the request channel inside the last call to <code>batched_call</code> just before <code>take!(promise)</code>.</p>
<p>But it sounds like a tedious interface to use. I wonder what's the best way to handle this...</p>



<a name="238948833"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238948833" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238948833">(May 16 2021 at 04:36)</a>:</h4>
<p>Since termination is rather tricky, I'd check if a dumb solution like just "processing <code>batchsize</code> items in each FOO" works. If FOO processes a much larger number of items than <code>batchsize</code>, I think it'd be much simpler.</p>



<a name="238949903"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238949903" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash Dalmia <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238949903">(May 16 2021 at 05:00)</a>:</h4>
<p>Do you think asyncmap would be a good fit for this?http://web.mit.edu/julia_v0.6.0/julia/share/doc/julia/html/en/stdlib/parallel.html#Base.asyncmap</p>
<p>Alternatively, I’m wondering if something as simple as having a channel with max size 32, and then an atomic counter variable, so that whenever the counter hits 32, it reads 32 elements from the channel and processes them. Then, it would free up the channel.</p>



<a name="238950421"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238950421" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238950421">(May 16 2021 at 05:11)</a>:</h4>
<p>If you have <code>ncalls</code> calls to FOO (e.g., 100 here), processing <code>(ncalls ÷ 32) * 32</code> elements is already possible with a small tweak to your MWE:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">batch_processor</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}})</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Promise</span><span class="p">}</span>
    <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c"># list of images to classify</span>
    <span class="c"># support 32 elements, but if less, don't give empty elements back</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">X</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>
    <span class="n">promises</span> <span class="o">=</span> <span class="n">sizehint!</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Promise</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">batchsize</span><span class="p">)</span>

    <span class="c"># classify the images in batches</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">in</span> <span class="n">request</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">push!</span><span class="p">(</span><span class="n">promises</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">nitems</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">nitems</span> <span class="o">==</span> <span class="n">batchsize</span>
                <span class="nd">@info</span> <span class="n">xs</span>
                <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                <span class="n">empty!</span><span class="p">(</span><span class="n">promises</span><span class="p">)</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">end</span>
        <span class="k">end</span>
        <span class="c"># classify any leftovers</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">isempty</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
            <span class="n">foreach</span><span class="p">(</span><span class="n">put!</span><span class="p">,</span> <span class="n">promises</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">catch</span>
        <span class="n">foreach</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">promises</span><span class="p">)</span>
        <span class="n">rethrow</span><span class="p">()</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}},</span> <span class="n">x</span><span class="o">::</span><span class="kt">X</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Y</span><span class="p">}</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">promise</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take!</span><span class="p">(</span><span class="n">promise</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="o">::</span><span class="kt">Channel</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">BAR</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
<span class="k">end</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">=</span> <span class="kt">Any</span>
<span class="n">request</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">{</span><span class="kt">Tuple</span><span class="p">{</span><span class="kt">X</span><span class="p">,</span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Y</span><span class="p">}}}()</span>   <span class="c"># (32) - maybe better if it's buffered; tuning needed</span>
<span class="n">ntasks</span> <span class="o">=</span> <span class="mi">100</span>


<span class="nd">@sync</span> <span class="k">try</span>
    <span class="nd">@async</span> <span class="k">try</span>
        <span class="n">batch_processor</span><span class="p">(</span><span class="n">BAR</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">catch</span> <span class="n">err</span>
        <span class="nd">@error</span> <span class="s">"Error in batch processor calls to BAR"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>
        <span class="n">rethrow</span><span class="p">()</span>
    <span class="k">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="nd">@sync</span> <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">ntasks</span>
        <span class="n">Threads</span><span class="o">.</span><span class="nd">@spawn</span> <span class="k">try</span>
            <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">catch</span> <span class="n">err</span>
            <span class="nd">@error</span> <span class="s">"Error in batch processor calls to BAR"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>
            <span class="n">rethrow</span><span class="p">()</span>

<span class="c">#         catch</span>
<span class="c">#             close(request)</span>
<span class="c">#             rethrow()</span>
        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">catch</span> <span class="n">err</span>
    <span class="nd">@error</span> <span class="s">"Error in sync calls to FOO"</span> <span class="n">exception</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">catch_backtrace</span><span class="p">())</span>
    <span class="n">rethrow</span><span class="p">()</span>

<span class="k">finally</span>
    <span class="n">close</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>



<a name="238950500"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238950500" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238950500">(May 16 2021 at 05:13)</a>:</h4>
<p>but the problem is rather how to end the "last" tasks executing FOO</p>



<a name="238950717"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238950717" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238950717">(May 16 2021 at 05:16)</a>:</h4>
<p>I'm not sure if asyncmap is helpful here.</p>



<a name="238950786"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Task%20and%20Channel%20for%20Batch%20Scheduling/near/238950786" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-(published)/topic/Task.20and.20Channel.20for.20Batch.20Scheduling.html#238950786">(May 16 2021 at 05:18)</a>:</h4>
<p>Maybe it's possible to write a generic solution if you can re-construct function FOO into the form</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">FOO</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">FOO_preprocess</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">batched_call</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
   <span class="n">z</span> <span class="o">=</span> <span class="n">FOO_postprocess</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">z</span>
<span class="k">end</span>
</code></pre></div>
<p>Then a higher-order function can take <code>FOO_preprocess</code>, <code>FOO_postprocess</code>, <code>BAR</code>, and <code>batchsize</code> and call them appropriately.</p>



<hr><p>Last updated: Jun 27 2021 at 11:01 UTC</p>
</html>