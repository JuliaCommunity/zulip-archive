<html>
<head><meta charset="utf-8"><title>Synchronization of multiple async tasks · helpdesk (published) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html">Synchronization of multiple async tasks</a></h3>

<hr>

<base href="https://julialang.zulipchat.com">

<head><link href="https://juliacommunity.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="247954939"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247954939" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247954939">(Aug 02 2021 at 18:47)</a>:</h4>
<p>Today I was trying to solve an issue of synchronous termination of async tasks (only async, no multithreading) in case if one of them fail, and came to this solution</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">foo</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="kt">Task</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">20</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nd">@task</span> <span class="k">begin</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">println</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="nd">@assert</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">5</span>
        <span class="k">end</span>
        <span class="n">push!</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">foreach</span><span class="p">(</span><span class="n">schedule</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="nd">@async</span> <span class="k">begin</span>
        <span class="k">while</span> <span class="nb">true</span>
            <span class="n">all</span><span class="p">(</span><span class="n">istaskdone</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">any</span><span class="p">(</span><span class="n">istaskfailed</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="k">in</span> <span class="n">ts</span>
                    <span class="n">istaskdone</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
                    <span class="n">istaskfailed</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
                    <span class="nd">@async</span> <span class="k">try</span> <span class="n">Base</span><span class="o">.</span><span class="n">throwto</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="kt">InterruptException</span><span class="p">())</span> <span class="k">catch</span> <span class="k">end</span>
                    <span class="n">yield</span><span class="p">()</span>
                <span class="k">end</span>
                <span class="k">break</span>
            <span class="k">end</span>
            <span class="n">yield</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">nothing</span>
<span class="k">end</span>
</code></pre></div>
<p>I wonder is it complete madness or it is more or less ok? Maybe there are better, more idiomatic ways to solve this problem?</p>



<a name="247958796"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247958796" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247958796">(Aug 02 2021 at 19:18)</a>:</h4>
<p><code>Base.throwto</code> (or <code>schedule</code>) on task that you don't "own" is undefined behavior. Also, I'd avoid spinning like this as much as possible.</p>
<p>Funny story, I was answering a similar question in slack today <a href="https://julialang.slack.com/archives/C6SMTHQ3T/p1627916665016700?thread_ts=1627899423.013900&amp;cid=C6SMTHQ3T">https://julialang.slack.com/archives/C6SMTHQ3T/p1627916665016700?thread_ts=1627899423.013900&amp;cid=C6SMTHQ3T</a></p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="nd">@sync</span> <span class="k">let</span> <span class="n">handles</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">(</span><span class="nb">Inf</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
        <span class="nd">@async</span> <span class="k">begin</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">try</span>
                <span class="k">try</span>
                    <span class="n">put!</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">timer</span><span class="p">)</span>
                <span class="k">catch</span>
                    <span class="n">close</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>  <span class="c"># closed by another task</span>
                    <span class="k">return</span>
                <span class="k">end</span>
                <span class="k">try</span>
                    <span class="n">wait</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
                <span class="k">catch</span> <span class="n">err</span>
                    <span class="n">err</span> <span class="k">isa</span> <span class="kt">EOFError</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>  <span class="c"># closed by another task</span>
                    <span class="n">rethrow</span><span class="p">()</span>
                <span class="k">end</span>
                <span class="n">println</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="nd">@assert</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">5</span>
            <span class="k">catch</span>
                <span class="n">close</span><span class="p">(</span><span class="n">handles</span><span class="p">)</span>  <span class="c"># no more `put!`</span>
                <span class="n">foreach</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">handles</span><span class="p">)</span>  <span class="c"># cancel all `wait(timer)`</span>
                <span class="n">rethrow</span><span class="p">()</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>



<a name="247960237"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247960237" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247960237">(Aug 02 2021 at 19:29)</a>:</h4>
<blockquote>
<p><code>Base.throwto</code> (or <code>schedule</code>) on task that you don't "own" is undefined behavior.</p>
</blockquote>
<p>Can you elaborate on that? I know Jameson usually discourages people from doing that, but I'm not sure why (it might cause task queue inconsistencies or something, I guess)</p>



<a name="247960560"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247960560" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247960560">(Aug 02 2021 at 19:31)</a>:</h4>
<p>I also wonder, is it fundamental limitation that killing tasks that aren't owned is undefined? Or it's just current Julia implementation and it may change in the future?</p>
<p>I mean, from pedestrian point of view, there is nothing bad in killing some task (or delegate it to some authority if such exists).</p>



<a name="247960622"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247960622" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247960622">(Aug 02 2021 at 19:32)</a>:</h4>
<blockquote>
<p>Funny story, I was answering a similar question in slack today</p>
</blockquote>
<p>Yes, I have the same question from the same guy in our Telegram channel :-)</p>



<a name="247960888"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247960888" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247960888">(Aug 02 2021 at 19:33)</a>:</h4>
<p>FWIW, Juno and the VSCode extension <code>schedule</code> <code>InterruptExceptions</code> on an execution task and, anecdotally, that seems to work fairly well</p>



<a name="247961001"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247961001" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247961001">(Aug 02 2021 at 19:34)</a>:</h4>
<p>But in those cases I really want to be able to interrupt arbitrary code</p>



<a name="247961356"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247961356" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247961356">(Aug 02 2021 at 19:37)</a>:</h4>
<p>Hmm, but in Takafumi example, <code>sleep</code> is changed to <code>timer</code>. In real code, there will be no <code>sleep </code>of course, there will be some long running task (for example <code>HTTP.get</code>).</p>



<a name="247961398"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247961398" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247961398">(Aug 02 2021 at 19:37)</a>:</h4>
<p>Can this snippet be changed to support this situation as well?</p>



<a name="247961748"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247961748" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247961748">(Aug 02 2021 at 19:40)</a>:</h4>
<p>It should starts with something like</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">url</span> <span class="o">=</span> <span class="s">"http://example.url"</span>
<span class="nd">@sync</span> <span class="k">let</span> <span class="n">handles</span> <span class="o">=</span> <span class="kt">Channel</span><span class="p">(</span><span class="nb">Inf</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
        <span class="nd">@async</span> <span class="k">begin</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="s">"</span><span class="si">$url</span><span class="s">/</span><span class="si">$i</span><span class="s">"</span>
           <span class="k">try</span>
             <span class="n">HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="o">???</span>
          <span class="k">catch</span>
              <span class="o">???</span>
         <span class="k">end</span>
     <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>



<a name="247964149"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247964149" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247964149">(Aug 02 2021 at 20:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="208845">Sebastian Pfitzner</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/247960888">said</a>:</p>
<blockquote>
<p>FWIW, Juno and the VSCode extension <code>schedule</code> <code>InterruptExceptions</code> on an execution task and, anecdotally, that seems to work fairly well</p>
</blockquote>
<p>Hasn't Workqueue inconsistency become a problem?</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="nd">@async</span> <span class="nb">nothing</span>
       <span class="n">Base</span><span class="o">.</span><span class="n">throwto</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="kt">KeyError</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="n">WARNING</span><span class="o">:</span> <span class="n">Workqueue</span> <span class="n">inconsistency</span> <span class="n">detected</span><span class="o">:</span> <span class="n">popfirst!</span><span class="p">(</span><span class="n">Workqueue</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="ss">:runnable</span>
<span class="o">^</span><span class="n">CERROR</span><span class="o">:</span> <span class="kt">InterruptException</span><span class="o">:</span>
</code></pre></div>
<p>Nothing can stop <code>throwto</code>-ing to a task that is in the workqueue. And it'd confuse scheduler since it thinks everything there is runnable.</p>
<p>Also, <code>schedule</code> in general is problematic since it sets the result in the task field non-atomically. It means that doing so from different worker thread is a data race.</p>



<a name="247964412"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247964412" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247964412">(Aug 02 2021 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="272771">Andrey Oskin</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/247961356">said</a>:</p>
<blockquote>
<p>Hmm, but in Takafumi example, <code>sleep</code> is changed to <code>timer</code>. In real code, there will be no <code>sleep </code>of course, there will be some long running task (for example <code>HTTP.get</code>).</p>
</blockquote>
<p>Yeah, you'd need some <code>close</code>-able object there. Does HTTP have <code>open</code>-like API?</p>
<p>But I know it's tedious and non-composable pattern...</p>



<a name="247966774"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247966774" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247966774">(Aug 02 2021 at 20:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="272771">Andrey Oskin</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/247960560">said</a>:</p>
<blockquote>
<p>I also wonder, is it fundamental limitation that killing tasks that aren't owned is undefined? Or it's just current Julia implementation and it may change in the future?</p>
</blockquote>
<p>I <em>think</em> it's implementable but I still don't know the task runtime end-to-end.</p>



<a name="247967136"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247967136" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247967136">(Aug 02 2021 at 20:27)</a>:</h4>
<blockquote>
<p>Hasn't Workqueue inconsistency become a problem?</p>
</blockquote>
<p>No. I also don't care about the return value of that task (it basically lives forever and I communicate with it via a Channel), so non-atomically setting the result doesn't matter</p>



<a name="247969021"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247969021" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247969021">(Aug 02 2021 at 20:43)</a>:</h4>
<p>If you are using it with threading, non-atomically setting it breaks your program. There's absolutely no guarantee that the object you set is meaningful on the reader's side.</p>
<p>Even if everything is <code>@async</code> task, I think it'd be nice to handle this the right way in an important software like VS code plugin.</p>



<a name="247969594"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247969594" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247969594">(Aug 02 2021 at 20:49)</a>:</h4>
<p>What I was trying to say is that the result is <em>never</em> read</p>



<a name="247969617"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247969617" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247969617">(Aug 02 2021 at 20:49)</a>:</h4>
<p>But yes, I'm all for cleaning up that part of the codebase!</p>



<a name="247970963"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247970963" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247970963">(Aug 02 2021 at 21:00)</a>:</h4>
<blockquote>
<p>Yeah, you'd need some close-able object there. Does HTTP have open-like API?</p>
</blockquote>
<p>Well, according to their documentation there is something <code>open</code> like:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">HTTP</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://tinyurl.com/bach-cello-suite-1-ogg"</span><span class="p">)</span> <span class="k">do</span> <span class="n">http</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">startread</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">"Content-Length"</span><span class="p">))</span>
    <span class="n">open</span><span class="p">(</span><span class="sb">`vlc -q --play-and-exit --intf dummy -`</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">do</span> <span class="n">vlc</span>
        <span class="k">while</span> <span class="o">!</span><span class="n">eof</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="n">bytes</span> <span class="o">=</span> <span class="n">readavailable</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
            <span class="n">write</span><span class="p">(</span><span class="n">vlc</span><span class="p">,</span> <span class="n">bytes</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">length</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
            <span class="n">println</span><span class="p">(</span><span class="s">"streamed </span><span class="se">\$</span><span class="s">n-bytes </span><span class="se">\$</span><span class="s">((100*n)÷l)%</span><span class="se">\\</span><span class="s">u1b[1A"</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The problem is they have many layers of request processing. Not sure at which point things became <code>@async</code>.</p>



<a name="247972485"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247972485" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247972485">(Aug 02 2021 at 21:16)</a>:</h4>
<p>If <code>close</code> on <code>HTTP.open</code> is "<code>@async</code>-safe", maybe you can do something like</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">HTTP</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">do</span> <span class="n">http</span>
    <span class="n">put!</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>
    <span class="o">...</span> <span class="c"># actual processing</span>
<span class="k">end</span>
</code></pre></div>
<p>where the <code>handles</code> is the <code>Channel</code> in my example.</p>



<a name="247972712"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247972712" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247972712">(Aug 02 2021 at 21:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="208845">Sebastian Pfitzner</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/247969594">said</a>:</p>
<blockquote>
<p>What I was trying to say is that the result is <em>never</em> read</p>
</blockquote>
<p>Exception is a result internally. Here's <code>Base.throwto</code> (similar code in <code>schedule</code> too)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">throwto</span><span class="p">(</span><span class="n">t</span><span class="o">::</span><span class="kt">Task</span><span class="p">,</span> <span class="nd">@nospecialize</span> <span class="n">exc</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">exc</span>
    <span class="n">t</span><span class="o">.</span><span class="n">_isexception</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">set_next_task</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">try_yieldto</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p><a href="https://github.com/JuliaLang/julia/blob/f711f0a9076b9f11f9034985086d73bc285c2ca6/base/task.jl#L772-L777">https://github.com/JuliaLang/julia/blob/f711f0a9076b9f11f9034985086d73bc285c2ca6/base/task.jl#L772-L777</a></p>
<p>So, internally, the exception is just a result with <code>_isexception</code> flag set. To throw an exception, the task needs to load it from the <code>.result</code> field.</p>



<a name="247973138"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247973138" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247973138">(Aug 02 2021 at 21:20)</a>:</h4>
<p>Ah, that makes sense.</p>



<a name="247975055"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247975055" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247975055">(Aug 02 2021 at 21:40)</a>:</h4>
<p>I still don't know a) which consequences any data races could have in this case and b) what to do about it <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="247978063"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/247978063" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#247978063">(Aug 02 2021 at 22:12)</a>:</h4>
<p>a) It can create an ill-formed Julia object. Since it can then corrupt the Julia runtime, anything can happen. You get a segfault if you are lucky. It's like a misplaced <code>@inbounds</code>. But worse, since the error can be hard to reproduce.</p>
<p>b) Supporting cancellation is tedious ATM, unfortunately. You can keep around <code>close</code>-able objects like my example above. Or, pass around <code>Threads.Atomic{Bool}</code> and check it from time to time.</p>



<a name="248177961"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248177961" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248177961">(Aug 03 2021 at 03:08)</a>:</h4>
<p>I wonder, how structured concurrency is possible then (or how trio framework is working). If I get it right, nursery gracefully shutdown all children, but it looks impossible in current Julia implementation?</p>
<p>I mean, you have a function, function is wrapped in task. The only way to stop the task externally is to set this isexception field and then it removes itself from the schedule. But this wouldn't gracefully unallocate all resources, right?</p>
<p>So, how on earth, one can externally close the task in such a way that it would gracefully release all the resources? Task should keep track of all allocated resources (like all open files), but there is no way to do it, since there is no direct communication between function and wrapping task.</p>



<a name="248177971"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248177971" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248177971">(Aug 03 2021 at 03:09)</a>:</h4>
<p>Sorry maybe I mixing different concepts together, but it really looks more complicated now, then I thought before.</p>



<a name="248178656"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248178656" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248178656">(Aug 03 2021 at 03:26)</a>:</h4>
<p>Yeah, it is implemented in other systems. It should also be possible to implement this as a package given all possibly blocking operations go through a consistent API. I <em>think</em> it is possible to do this in the Julia runtime with some manageable surgery. The main issue probably is convincing core devs that this is worth doing.</p>



<a name="248181225"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248181225" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248181225">(Aug 03 2021 at 04:32)</a>:</h4>
<p>Ah, but how it can be implemented? I am sorry, my knowledge of those things is too little.</p>
<p>Should it be made in such a way, that for example <code>open(io)</code> should be rewritten in such a way, that it leaves trace in wrapping Task? So that if task is interrupted it can call <code>close</code> on all such objects? It is it something different entirely (idk, some magic with stacktraces or may be even with garbage collector).</p>
<p>I mean, it would be interesting to see this technique implemented, even as a package prototype.</p>



<a name="248181400"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248181400" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248181400">(Aug 03 2021 at 04:36)</a>:</h4>
<p>I also seen word Tapir when things like this is discussed, but I do not know, is it relevant or not.</p>



<a name="248184710"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248184710" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248184710">(Aug 03 2021 at 05:56)</a>:</h4>
<p>Yeah, that's the idea. I think creating a package for this would be useful.</p>
<p>(It is limited in the sense that you can't keep channel/timer/file/etc. open upon task termination, compared to full-blown Structured Concurrency systems like Trio. For this, you'd need to touch the runtime or have something like Go's select.)</p>



<a name="248184729"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248184729" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248184729">(Aug 03 2021 at 05:57)</a>:</h4>
<p>Tapir is not related to the cancellation story.</p>



<a name="248186390"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248186390" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248186390">(Aug 03 2021 at 06:33)</a>:</h4>
<p>Sorry for keeping asking you questions, but what do you mean by "touching runtime"? I mean all things like closing/deallocating resources happens in a runtime, how is it diiferent?</p>
<p>And what is the technique behind Go <code>select</code>? Where one can read about it? Can it be implemented in Julia in some way (I mean, maybe even through touching low level things in LLVM somehow)? Or it will go very deep in Julia semantics?</p>



<a name="248302006"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248302006" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248302006">(Aug 04 2021 at 01:31)</a>:</h4>
<p>I'm happy to nerd out about this :)</p>
<p>By "touching runtime," I meant inserting cancellation point for each yield to the runtime; e.g., <code>read</code>ing a socket, <code>take!</code> on a channel, <code>lock</code>, etc. These operations need to "listen to" the actual I/O outcome (e.g., data read from the socket) <em>and</em> the cancellation signal.</p>
<p><span class="user-mention silent" data-user-id="272771">Andrey Oskin</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/248186390">said</a>:</p>
<blockquote>
<p>And what is the technique behind Go <code>select</code>? Where one can read about it?</p>
</blockquote>
<p>See how Go's <code>context</code> <a href="https://pkg.go.dev/context">https://pkg.go.dev/context</a> (coupled with <code>errgroup</code> <a href="https://pkg.go.dev/golang.org/x/sync/errgroup">https://pkg.go.dev/golang.org/x/sync/errgroup</a>) implements (something equivalent to) structured concurrency with the "<code>Done</code> channel idiom."</p>
<p><span class="user-mention silent" data-user-id="272771">Andrey Oskin</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks/near/248186390">said</a>:</p>
<blockquote>
<p>Can it be implemented in Julia in some way (I mean, maybe even through touching low level things in LLVM somehow)?</p>
</blockquote>
<p>I think it's totally implementable by just writing plain Julia code. No need to use LLVM hacking or even any kind of metaprogramming.</p>
<p>But the catch is that you'd need to re-implement <em>all</em> concurrent communication primitives (lock, condition variable, channel, ...) if you want to support cancellation (or <code>select</code>-like operations) on them. It is doable, and in fact I'm experimenting with it a bit.</p>
<p>It's probably easier to just directly implement channel and <code>select</code> only for channel (Go's strategy). But I have a bit more roundabout idea: (1) Implement Reagent (<a href="https://doi.org/10.1145/2254064.2254084">https://doi.org/10.1145/2254064.2254084</a>) (2) Implement Concurrent ML (<a href="https://en.wikipedia.org/wiki/Concurrent_ML">https://en.wikipedia.org/wiki/Concurrent_ML</a>) on top of it (3) Implement Racket's Kill-safe synchronization abstractions (<a href="https://doi.org/10.1145/996893.996849">https://doi.org/10.1145/996893.996849</a>) on top of it. This hopefully gives us very extensible concurrent synchronization mechanism which <em>then</em> let us create very user-friendly concurrency API like Trio on top of it.</p>



<a name="248302337"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248302337" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248302337">(Aug 04 2021 at 01:38)</a>:</h4>
<p>More resources:</p>
<p>A talk on OCaml's Reagent implementation. A nice high-level overview:<br>
<a href="https://www.youtube.com/watch?v=qRWTws_YPBA">LDN Functionals #8 KC Sivaramakrishnan: OCaml multicore and programming with Reagents - YouTube</a></p>
<div class="youtube-video message_inline_image"><a data-id="qRWTws_YPBA" href="https://www.youtube.com/watch?v=qRWTws_YPBA"><img src="https://uploads.zulipusercontent.net/34ada58b7a6b77bd99c3d6f45ce13087e2026a88/68747470733a2f2f692e7974696d672e636f6d2f76692f7152575477735f595042412f64656661756c742e6a7067"></a></div><p>A talk on the high-level idea of Concurrent ML. The code is kinda hard to read which is rather sad. But I think it's a nice accessible introduction. I learnt about Reagent via this talk.<br>
<a href="https://www.youtube.com/watch?v=pf4VbP5q3P0">Michael Sperber - Concurrent ML - The One That Got Away - Code Mesh 2017 - YouTube</a></p>
<div class="youtube-video message_inline_image"><a data-id="pf4VbP5q3P0" href="https://www.youtube.com/watch?v=pf4VbP5q3P0"><img src="https://uploads.zulipusercontent.net/944bb8071c3952de25ac25f34b527172773724d7/68747470733a2f2f692e7974696d672e636f6d2f76692f70663456625035713350302f64656661756c742e6a7067"></a></div><p>Another talk on Concurrent ML. It was kinda hard to follow for me. But it goes into some implementation details.<br>
<a href="https://www.youtube.com/watch?v=7IcI6sl5oBc">Andy Wingo - Channels, Concurrency, and Cores: A new Concurrent ML implementation - YouTube</a></p>
<div class="youtube-video message_inline_image"><a data-id="7IcI6sl5oBc" href="https://www.youtube.com/watch?v=7IcI6sl5oBc"><img src="https://uploads.zulipusercontent.net/764e4a2fae4fd5572f8e0dcf212df63a1719977f/68747470733a2f2f692e7974696d672e636f6d2f76692f3749634936736c356f42632f64656661756c742e6a7067"></a></div>



<a name="248304005"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248304005" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248304005">(Aug 04 2021 at 02:11)</a>:</h4>
<p>But, as I said before, it's totally possible that a package that automates the <code>close</code>-on-cancel pattern is sufficient for many practical problems. I know I'm in a rather deep stack of yak shaving :)</p>



<a name="248312820"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248312820" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> c42f <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248312820">(Aug 04 2021 at 05:40)</a>:</h4>
<p>Haha, deep indeed. The other day I was reading <a href="https://carllerche.com/2021/06/17/six-ways-to-make-async-rust-easier/">https://carllerche.com/2021/06/17/six-ways-to-make-async-rust-easier/</a>  which discusses kill safety (or the lack of it) in Rust. It's a good thoughtful writeup of the current state of some of these things in Rust. We don't have cancellation in Julia, so we don't have some of their problems yet.  But otoh we have all the other problems that lack of cancellation causes <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="248326507"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248326507" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Pfitzner <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248326507">(Aug 04 2021 at 09:11)</a>:</h4>
<p>Related: <a href="https://github.com/search?q=CancellationTokens.jl&amp;type=Repositories">CancellationTokens.jl</a></p>



<a name="248575488"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248575488" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248575488">(Aug 06 2021 at 06:19)</a>:</h4>
<p>So, here's the first step in my attempt to support cancellation in a rather roundabout way: <a href="https://github.com/tkf/Reagents.jl">https://github.com/tkf/Reagents.jl</a></p>
<p>I tired to summarize what I was saying above here: <a href="https://github.com/tkf/Reagents.jl/discussions/5">https://github.com/tkf/Reagents.jl/discussions/5</a></p>



<a name="248583796"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248583796" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248583796">(Aug 06 2021 at 08:25)</a>:</h4>
<p>Oh, I am so anxious to give it a spin :-)<br>
That nice feeling of christmas present unpacking :-D</p>



<a name="248664323"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/248664323" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#248664323">(Aug 06 2021 at 20:28)</a>:</h4>
<p>This is still a very low-level infrastructure. So don't hold your breath yet :)</p>



<a name="251168335"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/251168335" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jameson Nash <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#251168335">(Aug 30 2021 at 00:06)</a>:</h4>
<p>The rust link from <span class="user-mention" data-user-id="269205">@Chris Foster</span> seems to be proposing the fix for all their issues is to do what we do now in Julia (with implicit cancellation tokens on resources):</p>
<blockquote>
<p>Cancel spawned tasks by disabling resources from completing.</p>
</blockquote>



<a name="251168384"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/251168384" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jameson Nash <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#251168384">(Aug 30 2021 at 00:07)</a>:</h4>
<p><span class="user-mention" data-user-id="297129">@Takafumi Arakaki (tkf)</span> I like that code snippet you posted at the top. Have you ever thought about how we could automate that better? I have wanted to make <code>@sync</code> also be able to manage in-flight resources like that, but been unsure where to start on it.</p>



<a name="251176053"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/251176053" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#251176053">(Aug 30 2021 at 02:27)</a>:</h4>
<p>Good to know that you like the example! It was basically an outcome of me trying to understand your philosophy of the error handling/cancellation of concurrent programs :), to figure out the best practice for doing this in current Julia.</p>
<p>To add something like <code>handle</code> to <code>@sync</code>, I think the main questions are:</p>
<p>(1) Should <code>handle</code> be dynamically or lexically scoped? I prefer dynamically scoped direction but then we'd need to use something like task-local or context variable or this.</p>
<p>Or maybe it can be done lexically by default but we can also add a macro <code>@syncgorup()</code> that returns an object wrapping the current <code>sync_varname</code> and <code>handle</code>. We can then <code>bind</code> a closable object to the "syncgroup" object. It's still a bit manual but it's nice to automate the <code>try</code>-<code>catch</code> dance. In the lexical environment of <code>@sync</code>, we can simply use (say) <code>@syncbind</code> or something.</p>
<p>(2) Should the exit be non-local? In my code I used <code>return</code>s like this</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">try</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span>
<span class="k">catch</span> <span class="n">err</span>
    <span class="n">err</span> <span class="k">isa</span> <span class="kt">EOFError</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>  <span class="c"># closed by another task</span>
    <span class="n">rethrow</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div>
<p>I could use <code>return</code> here since I know it'd end <code>@async</code>. But we can't do this for arbitrary code (e.g., the user might want to push an object to a deal with the <code>timer</code> inside a <code>open(...) do</code> block). If we go this direction, I think we'd need something like a <code>Cancelled</code> exception.</p>
<p>Once these design decisions are address, I imagine implementation would be straightforward.</p>



<a name="251176112"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/251176112" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#251176112">(Aug 30 2021 at 02:28)</a>:</h4>
<p>Also, FYI, lexically scoped non-local cancellation is now implemented in <a href="https://github.com/tkf/Julio.jl">https://github.com/tkf/Julio.jl</a></p>



<a name="251176875"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Synchronization%20of%20multiple%20async%20tasks/near/251176875" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Takafumi Arakaki (tkf) <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Synchronization.20of.20multiple.20async.20tasks.html#251176875">(Aug 30 2021 at 02:42)</a>:</h4>
<p>Just reading the Rust blog, I didn't realize Tokio's <code>select</code> does not guarantee atomicity. It seems like an unfortunate design... (The blog post also discuss restricting it.)</p>
<p>Reagents actually help writing something like this. <code>Julio.select</code> does not consume an <code>IO</code> if it's not selected: <a href="https://tkf.github.io/Julio.jl/dev/tutorials/select/#Selecting-an-arbitrary-event">https://tkf.github.io/Julio.jl/dev/tutorials/select/#Selecting-an-arbitrary-event</a> (It's done using a manager task ATM but I think it's possible to avoid this by touching lower-level interface)</p>



<hr><p>Last updated: Nov 01 2025 at 04:39 UTC</p>
</html>