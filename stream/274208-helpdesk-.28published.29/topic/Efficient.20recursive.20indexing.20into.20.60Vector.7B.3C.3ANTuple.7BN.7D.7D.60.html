<html>
<head><meta charset="utf-8"><title>Efficient recursive indexing into `Vector{&lt;:NTuple{N}}` · helpdesk (published) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html">Efficient recursive indexing into `Vector{&lt;:NTuple{N}}`</a></h3>

<hr>

<base href="https://julialang.zulipchat.com">

<head><link href="https://juliacommunity.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="449054102"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449054102" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449054102">(Jul 04 2024 at 10:24)</a>:</h4>
<p>I have a special structure that's basically a vector where every element is a Tuple of the same length, and I want to recursively index into it. So for example, I want </p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">recursive_getindex</span><span class="p">([(</span><span class="ss">:a</span><span class="p">,</span><span class="w"> </span><span class="ss">:b</span><span class="p">,</span><span class="w"> </span><span class="ss">:c</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="ss">:d</span><span class="p">,</span><span class="w"> </span><span class="ss">:e</span><span class="p">,</span><span class="w"> </span><span class="ss">:f</span><span class="p">)],</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:d</span>
</code></pre></div>
<p>I'm currently doing this with <code>divrem</code> to find the outer index and the inner index, but I feel like there should be an efficient way to do it. My instinct would be to use <code>reinterpret</code>, but I want to be able to support Tuples that might be padded or non-isbits.</p>



<a name="449054150"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449054150" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449054150">(Jul 04 2024 at 10:24)</a>:</h4>
<p>Any suggestions for how to go about this?</p>



<a name="449054415"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449054415" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sukera <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449054415">(Jul 04 2024 at 10:26)</a>:</h4>
<p><code>divrem</code> is pretty optimal for this, since you're doing basically the same operation as for indexing a matrix linearly</p>



<a name="449058350"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449058350" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449058350">(Jul 04 2024 at 10:50)</a>:</h4>
<p>Hm, I think I must be doing something wrong then because it's quite slow compared to linearly accessing a matrix:</p>
<div class="codehilite" data-code-language="Julia console"><pre><span></span><code><span class="gp">julia&gt;</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">recursive_getindex</span><span class="p">(</span><span class="n">v</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">NTuple</span><span class="p">{</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="kt">T</span><span class="p">}},</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="kt">T</span><span class="p">}</span>
<span class="w">           </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">divrem</span><span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
<span class="w">           </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="w">       </span><span class="k">end</span><span class="p">;</span>

<span class="gp">julia&gt;</span><span class="w"> </span><span class="k">let</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">           </span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">recursive_getindex</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="p">(</span><span class="o">$</span><span class="n">M</span><span class="o">*$</span><span class="n">N</span><span class="p">))</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="n">ntuple</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="n">rand</span><span class="p">(),</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">∈</span><span class="w"> </span><span class="mi">1</span><span class="o">:$</span><span class="n">N</span><span class="p">])</span>
<span class="w">           </span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getindex</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="p">(</span><span class="o">$</span><span class="n">M</span><span class="o">*$</span><span class="n">N</span><span class="p">))</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">rand</span><span class="p">(</span><span class="o">$</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">N</span><span class="p">))</span>
<span class="w">       </span><span class="k">end</span>
<span class="go">  33.739 ns (0 allocations: 0 bytes)</span>
<span class="go">  12.827 ns (0 allocations: 0 bytes)</span>
<span class="go">17.3642736448238</span>
</code></pre></div>



<a name="449058723"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449058723" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449058723">(Jul 04 2024 at 10:51)</a>:</h4>
<p>I guess what I should be doing is maybe interally just storing a <code>Vector{T}</code> and then have a function for taking <code>M</code> elements at a time as a <code>Tuple</code>, since I know I can make that fast.</p>



<a name="449080993"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449080993" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sukera <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449080993">(Jul 04 2024 at 12:55)</a>:</h4>
<p>well it still has to load the tuple element first, seems like it doesn't want to fold that into one operation for some reason</p>



<a name="449081603"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449081603" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sukera <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449081603">(Jul 04 2024 at 12:58)</a>:</h4>
<p>e.g. with</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Base</span><span class="o">.</span><span class="nd">@propagate_inbounds</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">recursive_getindex</span><span class="p">(</span><span class="n">v</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">NTuple</span><span class="p">{</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="kt">T</span><span class="p">}},</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="kt">T</span><span class="p">}</span>
<span class="w">    </span><span class="nd">@boundscheck</span><span class="w"> </span><span class="n">checkbounds</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span>
<span class="w">    </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">divrem</span><span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@inbounds</span><span class="w"> </span><span class="k">begin</span>
<span class="w">       </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span>
<span class="k">end</span><span class="p">;</span>
</code></pre></div>
<p>I get</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span><span class="w"> </span><span class="n">code_native</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nd">@inbounds</span><span class="p">(</span><span class="n">recursive_getindex</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)),</span><span class="w"> </span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">NTuple</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="kt">Float64</span><span class="p">}},</span><span class="kt">Int</span><span class="p">);</span><span class="w"> </span><span class="n">dump_module</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">text</span>
<span class="p">;</span><span class="w"> </span><span class="n">┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span><span class="o">:</span><span class="mi">1</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`#87`</span>
<span class="w">    </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">r13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">│┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">3</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="p">;</span><span class="w"> </span><span class="n">││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">int</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">86</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`-`</span>
<span class="w">    </span><span class="n">dec</span><span class="w"> </span><span class="n">rsi</span>
<span class="w">    </span><span class="n">movabs</span><span class="w">  </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">6148914691236517206</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">│└└</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">│┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">3</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="p">;</span><span class="w"> </span><span class="n">││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">181</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`divrem`</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">203</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">int</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">295</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`div`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rsi</span>
<span class="w">    </span><span class="n">imul</span><span class="w">    </span><span class="n">rcx</span>
<span class="p">;</span><span class="w"> </span><span class="n">││└└</span>
<span class="p">;</span><span class="w"> </span><span class="n">││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">5</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="p">;</span><span class="w"> </span><span class="n">││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">907</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`getindex`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">││└</span>
<span class="p">;</span><span class="w"> </span><span class="n">││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">3</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="p">;</span><span class="w"> </span><span class="n">││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">181</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`divrem`</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">203</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">int</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">295</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`div`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span>
<span class="w">    </span><span class="n">shr</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span>
<span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││└</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">181</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`divrem`</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">div</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">204</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">int</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">88</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`*`</span>
<span class="w">    </span><span class="n">lea</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">rax</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">││└└</span>
<span class="p">;</span><span class="w"> </span><span class="n">││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">5</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="p">;</span><span class="w"> </span><span class="n">││┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">907</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`getindex`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rcx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">tuple</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">31</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`getindex`</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span>
<span class="p">;</span><span class="w"> </span><span class="n">│││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">907</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`getindex`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">rdx</span>
<span class="w">    </span><span class="n">vmovups</span><span class="w"> </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmmword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rcx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="n">rax</span><span class="p">]</span>
<span class="w">    </span><span class="n">vmovaps</span><span class="w"> </span><span class="n">xmmword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="n">xmm0</span>
<span class="p">;</span><span class="w"> </span><span class="n">││└</span>
<span class="p">;</span><span class="w"> </span><span class="n">││</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">7</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`recursive_getindex`</span>
<span class="w">    </span><span class="n">vmovsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rbp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="n">rsi</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="c"># xmm0 = mem[0],zero</span>
<span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span>
<span class="w">    </span><span class="n">ret</span>
<span class="p">;</span><span class="w"> </span><span class="n">└└</span>
<span class="p">;</span><span class="w"> </span><span class="n">┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span><span class="o">:</span><span class="mi">7</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`&lt;invalid&gt;`</span>
<span class="w">    </span><span class="n">nop</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="n">cs</span><span class="o">:</span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rax</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">└</span>
</code></pre></div>
<p>while the <code>Matrix</code> version can just load the value without having to do the intermediate <code>divrem</code>:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span><span class="w"> </span><span class="n">code_native</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nd">@inbounds</span><span class="p">(</span><span class="n">getindex</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)),</span><span class="w"> </span><span class="p">(</span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span><span class="kt">Int</span><span class="p">);</span><span class="w"> </span><span class="n">dump_module</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">text</span>
<span class="p">;</span><span class="w"> </span><span class="n">┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">REPL</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span><span class="o">:</span><span class="mi">1</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`#89`</span>
<span class="w">    </span><span class="n">push</span><span class="w">    </span><span class="n">rbp</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">r13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">│┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">907</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`getindex`</span>
<span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">]</span>
<span class="w">    </span><span class="n">vmovsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="o">*</span><span class="n">rsi</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="c"># xmm0 = mem[0],zero</span>
<span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span>
<span class="w">    </span><span class="n">ret</span>
<span class="p">;</span><span class="w"> </span><span class="n">└└</span>
<span class="p">;</span><span class="w"> </span><span class="n">┌</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">907</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="sb">`&lt;invalid&gt;`</span>
<span class="w">    </span><span class="n">nop</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rax</span><span class="p">]</span>
<span class="p">;</span><span class="w"> </span><span class="n">└</span>
</code></pre></div>



<a name="449081774"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449081774" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sukera <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449081774">(Jul 04 2024 at 12:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="269150">Mason Protter</span> <a href="#narrow/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60/near/449058723">said</a>:</p>
<blockquote>
<p>I guess what I should be doing is maybe interally just storing a <code>Vector{T}</code> and then have a function for taking <code>M</code> elements at a time as a <code>Tuple</code>, since I know I can make that fast.</p>
</blockquote>
<p>yeah, that's a good case for abstracting this away</p>



<a name="449082098"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449082098" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sukera <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449082098">(Jul 04 2024 at 13:01)</a>:</h4>
<p>that being said, why not store this as a <code>Matrix</code> internally, one tuple per column? the biggest difference time wise probably won't be the single element indexing anyway but the continued iteration &amp; order that's being done in</p>



<a name="449088113"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449088113" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449088113">(Jul 04 2024 at 13:28)</a>:</h4>
<p>Oh yeah, good idea with the storing a matrix internally!</p>



<a name="449150948"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449150948" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jar <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449150948">(Jul 04 2024 at 19:13)</a>:</h4>
<p>I don't see why this function is called <code>recursive_getindex</code>, isn't it more like <code>flattened_getindex</code>?</p>



<a name="449159653"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/Efficient%20recursive%20indexing%20into%20%60Vector%7B%3C%3ANTuple%7BN%7D%7D%60/near/449159653" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/Efficient.20recursive.20indexing.20into.20.60Vector.7B.3C.3ANTuple.7BN.7D.7D.60.html#449159653">(Jul 04 2024 at 20:17)</a>:</h4>
<p>Well, the real name is just <code>getindex</code>, I'm writing a method for a specific struct</p>



<hr><p>Last updated: Nov 01 2025 at 04:39 UTC</p>
</html>