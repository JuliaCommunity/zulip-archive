<html>
<head><meta charset="utf-8"><title>why is Optim.jl so slow? · helpdesk (published) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html">why is Optim.jl so slow?</a></h3>

<hr>

<base href="https://julialang.zulipchat.com">

<head><link href="https://juliacommunity.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="227131559"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227131559" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227131559">(Feb 21 2021 at 01:05)</a>:</h4>
<p>I have a research code which does multivariate optimization which runs for ~30s for each data point in Python. The code has been too slow to be analyzed, so I ported it to Julia, only to find that it takes ~160s (I used <code>@time optimize(...)</code>, precompilation time was probably included?) in Julia using <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a>!</p>
<p>So I tried doing a benchmark comparing <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> with scipy.optimize using the simplest function, and found that <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> is much slower. Any idea on how to speed up <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a>? My Julia version is 1.5.3, my Python version is 3.8.6. I'm on NixOS and have had trouble upgrading to the latest version of the OS, so can't try 1.6rc.</p>
<p>My Julia code:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">using</span> <span class="n">Optim</span>

<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
<span class="nd">@time</span> <span class="n">optimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">LBFGS</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="o">$</span> <span class="n">time</span> <span class="n">julia</span> <span class="n">bench</span><span class="o">.</span><span class="n">jl</span>
  <span class="mf">2.475465</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">4.23</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">217.432</span> <span class="n">MiB</span><span class="p">,</span> <span class="mf">4.38</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
<span class="n">julia</span> <span class="n">bench</span><span class="o">.</span><span class="n">jl</span>  <span class="mf">10.81</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.35</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">11.176</span> <span class="n">total</span>
</code></pre></div>
<p>My Python code:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">'L-BFGS-B'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'elapsed'</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="o">$</span> <span class="n">time</span> <span class="n">python</span> <span class="n">bench</span><span class="o">.</span><span class="n">py</span>
<span class="n">elapsed</span> <span class="mf">0.0051517486572265625</span>
<span class="n">python</span> <span class="n">bench</span><span class="o">.</span><span class="n">py</span>  <span class="mf">0.86</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.88</span><span class="n">s</span> <span class="n">system</span> <span class="mi">205</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">0.843</span> <span class="n">total</span>
</code></pre></div>



<a name="227132618"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227132618" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227132618">(Feb 21 2021 at 01:26)</a>:</h4>
<p>Mmm, I don't remember the optim defaults on derivatives, but, can you try</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">optimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="n">LBFGS</span><span class="p">(),</span><span class="n">autodiff</span><span class="o">=:</span><span class="n">forward</span><span class="p">)</span>
</code></pre></div>
<p>?</p>



<a name="227132817"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227132817" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227132817">(Feb 21 2021 at 01:31)</a>:</h4>
<p>With <code>autodiff=:forward</code> I got</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>   <span class="mf">3.208170</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">6.03</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">308.185</span> <span class="n">MiB</span><span class="p">,</span> <span class="mf">4.39</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
<span class="n">julia</span> <span class="n">bench</span><span class="o">.</span><span class="n">jl</span>  <span class="mf">11.42</span><span class="n">s</span> <span class="n">user</span> <span class="mf">0.33</span><span class="n">s</span> <span class="n">system</span> <span class="mi">99</span><span class="o">%</span> <span class="n">cpu</span> <span class="mf">11.767</span> <span class="n">total</span>
</code></pre></div>



<a name="227133036"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133036" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133036">(Feb 21 2021 at 01:35)</a>:</h4>
<p>And what about the real problem?</p>



<a name="227133087"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133087" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133087">(Feb 21 2021 at 01:36)</a>:</h4>
<p>OK, I will try on my real problem.</p>



<a name="227133092"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133092" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133092">(Feb 21 2021 at 01:36)</a>:</h4>
<p>That benchmark is measuring mainly the startup time of optim</p>



<a name="227133116"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133116" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133116">(Feb 21 2021 at 01:37)</a>:</h4>
<p>With autodiff=forward, you are creating the exact derivative via AD, so the evaluation of the gradient is faster</p>



<a name="227133298"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133298" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133298">(Feb 21 2021 at 01:41)</a>:</h4>
<p>I got this error:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Optim</span><span class="o">.</span><span class="n">ConjugateGradient</span>
<span class="n">ERROR</span><span class="o">:</span> <span class="kt">LoadError</span><span class="o">:</span> <span class="kt">MethodError</span><span class="o">:</span> <span class="n">no</span> <span class="n">method</span> <span class="n">matching</span> <span class="kt">Float64</span><span class="p">(</span><span class="o">::</span><span class="n">ForwardDiff</span><span class="o">.</span><span class="n">Dual</span><span class="p">{</span><span class="n">ForwardDiff</span><span class="o">.</span><span class="n">Tag</span><span class="p">{</span><span class="n">var</span><span class="s">"#_calc_U#16"</span><span class="p">{</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="kt">Int64</span><span class="p">,</span><span class="kt">Int64</span><span class="p">,</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Any</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span><span class="kt">Int64</span><span class="p">,</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">}},</span><span class="kt">Float64</span><span class="p">},</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">10</span><span class="p">})</span>
<span class="n">Closest</span> <span class="n">candidates</span> <span class="n">are</span><span class="o">:</span>
  <span class="kt">Float64</span><span class="p">(</span><span class="o">::</span><span class="kt">Real</span><span class="p">,</span> <span class="o">::</span><span class="kt">RoundingMode</span><span class="p">)</span> <span class="n">where</span> <span class="n">T</span><span class="o">&lt;:</span><span class="kt">AbstractFloat</span> <span class="n">at</span> <span class="n">rounding</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">200</span>
  <span class="kt">Float64</span><span class="p">(</span><span class="o">::</span><span class="n">T</span><span class="p">)</span> <span class="n">where</span> <span class="n">T</span><span class="o">&lt;:</span><span class="kt">Number</span> <span class="n">at</span> <span class="n">boot</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">716</span>
  <span class="kt">Float64</span><span class="p">(</span><span class="o">::</span><span class="kt">Float32</span><span class="p">)</span> <span class="n">at</span> <span class="n">float</span><span class="o">.</span><span class="n">jl</span><span class="o">:</span><span class="mi">255</span>
</code></pre></div>
<p>This is the line that calls the function:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>        <span class="n">result</span> <span class="o">=</span> <span class="n">Optim</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">xs0</span><span class="p">,</span> <span class="n">Optim</span><span class="o">.</span><span class="n">Fminbox</span><span class="p">(</span><span class="n">inner_optimizer</span><span class="p">()),</span> <span class="n">autodiff</span><span class="o">=:</span><span class="n">forward</span><span class="p">)</span>
</code></pre></div>



<a name="227133360"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133360" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133360">(Feb 21 2021 at 01:42)</a>:</h4>
<p>(What is the size of your input on the real problem? If it's too big, maybe using a reverse mode AD could speed up things significantly )</p>



<a name="227133381"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133381" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133381">(Feb 21 2021 at 01:43)</a>:</h4>
<p>The size of <code>xs0</code> is 30.</p>



<a name="227133441"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133441" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133441">(Feb 21 2021 at 01:44)</a>:</h4>
<p>There is no option for <code>:reverse</code>, I only saw <code>:finite</code> and <code>:forward</code>.</p>



<a name="227133442"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133442" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133442">(Feb 21 2021 at 01:44)</a>:</h4>
<p>On the problem found, that happens because you have somewhere in your function the expression <code>a=Float64(b) </code></p>



<a name="227133465"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133465" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133465">(Feb 21 2021 at 01:45)</a>:</h4>
<p>I grepped for the pattern <code>Float64(</code>, didn't find any.</p>



<a name="227133468"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133468" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133468">(Feb 21 2021 at 01:45)</a>:</h4>
<p>Optim doesn't have automatic reverse mode included, but at that size I think Forward is fine</p>



<a name="227133525"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133525" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133525">(Feb 21 2021 at 01:46)</a>:</h4>
<p>or maybe in the function signature?</p>



<a name="227133532"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133532" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133532">(Feb 21 2021 at 01:46)</a>:</h4>
<p><code>f(x::Float64) </code></p>



<a name="227133559"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133559" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133559">(Feb 21 2021 at 01:47)</a>:</h4>
<p>The only place where the text <code>Float64</code> exists at all is in a mutable struct definition, e.g.</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">mutable</span> <span class="k">struct</span> <span class="n">Firm</span> <span class="o">&lt;:</span> <span class="n">AbstractFirm</span>
    <span class="n">Eg</span><span class="o">::</span><span class="kt">Float64</span>
    <span class="n">E_greens</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">Eb</span><span class="o">::</span><span class="kt">Float64</span>
    <span class="n">E_browns</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
</code></pre></div>



<a name="227133640"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133640" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133640">(Feb 21 2021 at 01:49)</a>:</h4>
<p>(What a shame that I have to go back to Python again after convincing my collaborator to have 2-3 days to reimplementing in Julia)</p>



<a name="227133709"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133709" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133709">(Feb 21 2021 at 01:50)</a>:</h4>
<p>Do you mind putting the optimization problem here? , I cannot help much more without a working examole</p>



<a name="227133803"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133803" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133803">(Feb 21 2021 at 01:52)</a>:</h4>
<p>Thanks a lot for that! I'm not allowed to share the code at this point until the paper has been published, but I can send you the code via PM.</p>



<a name="227133851"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133851" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133851">(Feb 21 2021 at 01:53)</a>:</h4>
<p>Ok</p>



<a name="227133943"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227133943" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrés Riedemann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227133943">(Feb 21 2021 at 01:55)</a>:</h4>
<p>If you are running an optimization problem on each point, and your points are not related, you could try multithreading the calculation</p>



<a name="227134025"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134025" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134025">(Feb 21 2021 at 01:57)</a>:</h4>
<p>I will post relevant details in this topic so others can benefit once we have pinpointed the problem. Unfortunately to optimize xs[i], it depends on all the values from xs[1] to xs[i-1], because it is a time evolution.</p>



<a name="227134344"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134344" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134344">(Feb 21 2021 at 02:03)</a>:</h4>
<p>Though my concern still stands. <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> is much slower than scipy.optimize even on the simplest example.</p>



<a name="227134399"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134399" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Júlio Hoffimann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134399">(Feb 21 2021 at 02:04)</a>:</h4>
<p>Make sure that you are benchmarking things properly and not counting precompilation time. After that, try to share some minimum working example in both languages so that people can try to debug and help further.</p>



<a name="227134400"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134400" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134400">(Feb 21 2021 at 02:04)</a>:</h4>
<p>OK, nvm it's a precompilation problem.</p>



<a name="227134403"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134403" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Júlio Hoffimann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134403">(Feb 21 2021 at 02:04)</a>:</h4>
<p>Yes, as usual <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="227134417"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134417" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Júlio Hoffimann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134417">(Feb 21 2021 at 02:05)</a>:</h4>
<p>Also, consider Julia v1.6-rc1, it is really flying compared to the current Julia v1.5</p>



<a name="227134521"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134521" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Júlio Hoffimann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134521">(Feb 21 2021 at 02:06)</a>:</h4>
<p>To time the runtime of the optimize call from <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> you can start a Julia session and <code>include( "MWE.jl")</code> to introduce the definitions. After that you can <code>using BenchmarkTools</code> and <code>@btime optimize(...)</code></p>



<a name="227134543"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227134543" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227134543">(Feb 21 2021 at 02:07)</a>:</h4>
<p>OK, I will use <code>@btime</code> to avoid precompilation time.</p>



<a name="227135434"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227135434" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227135434">(Feb 21 2021 at 02:24)</a>:</h4>
<p>With btime.</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code>  <span class="mf">79.084</span> <span class="n">μs</span> <span class="p">(</span><span class="mi">699</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">32.27</span> <span class="n">KiB</span><span class="p">)</span>
<span class="n">julia</span> <span class="n">bench</span><span class="o">.</span><span class="n">jl</span>  <span class="mf">81.97</span><span class="n">s</span> <span class="n">user</span> <span class="mf">3.43</span><span class="n">s</span> <span class="n">system</span> <span class="mi">100</span><span class="o">%</span> <span class="n">cpu</span> <span class="mi">1</span><span class="o">:</span><span class="mf">25.28</span> <span class="n">total</span>
</code></pre></div>



<a name="227136943"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227136943" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227136943">(Feb 21 2021 at 03:01)</a>:</h4>
<p><span class="user-mention" data-user-id="284959">@Andrés Riedemann</span> has provided feedback in PM (appreciate it a lot):</p>
<ul>
<li>I used lots of global variables without <code>const</code>. Specifying <code>const</code> shaved down the time to ~76s (originally ~160s)</li>
<li>I created lots of empty arrays with <code>= []</code>. After specifying them to <code>Float64[]</code> or <code>Array{Float64,1}[]</code>, it's down to 64s.</li>
</ul>
<p>Note that the Scipy version is 30s.</p>



<a name="227140200"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227140200" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Júlio Hoffimann <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227140200">(Feb 21 2021 at 04:16)</a>:</h4>
<p>You can probably decrease it a bit more with a few code changes. I don't understand how you get a microsecond in Julia and a millisecond in Python and at the end your Python version is twice as fast? You said 64s vs 30s at the end right ?</p>



<a name="227141098"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227141098" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227141098">(Feb 21 2021 at 04:38)</a>:</h4>
<p>The millisecond vs microsecond is for the example code, which is already fully explained. The 64s vs 30s is the real code one.</p>



<a name="227161387"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227161387" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227161387">(Feb 21 2021 at 11:22)</a>:</h4>
<p>Did you make the real code fully non-allocating?</p>



<a name="227161397"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227161397" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227161397">(Feb 21 2021 at 11:23)</a>:</h4>
<p>and AD</p>



<a name="227161973"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227161973" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227161973">(Feb 21 2021 at 11:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="278119">Christopher Rackauckas</span> <a href="#narrow/stream/274208-helpdesk-(published)/topic/why.20is.20Optim.2Ejl.20so.20slow.3F/near/227161387">said</a>:</p>
<blockquote>
<p>Did you make the real code fully non-allocating?</p>
</blockquote>
<p>Huh, TIL. I specified the model params as global <code>const</code>, and my functions read from these consts directly instead of receiving them from function arguments.</p>



<a name="227162001"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227162001" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227162001">(Feb 21 2021 at 11:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="278119">Christopher Rackauckas</span> <a href="#narrow/stream/274208-helpdesk-(published)/topic/why.20is.20Optim.2Ejl.20so.20slow.3F/near/227161397">said</a>:</p>
<blockquote>
<p>and AD</p>
</blockquote>
<p>I assume <span class="user-mention silent" data-user-id="284959">Andrés Riedemann</span> 's suggestion to use <code>autodiff=:forward</code> is to enable AD?</p>



<a name="227162951"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227162951" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227162951">(Feb 21 2021 at 11:55)</a>:</h4>
<blockquote>
<p>I assume Andrés Riedemann 's suggestion to use autodiff=:forward is to enable AD?</p>
</blockquote>
<p>yes</p>



<a name="227162955"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227162955" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227162955">(Feb 21 2021 at 11:56)</a>:</h4>
<p>so if you <code>@time</code> your objective function you get 0 allocs?</p>



<a name="227164333"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164333" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164333">(Feb 21 2021 at 12:22)</a>:</h4>
<p>Nope, currently not yet lol</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Optim</span><span class="o">.</span><span class="n">ConjugateGradient</span>
<span class="n">elapsed</span><span class="o">:</span> <span class="mf">74.16639494895935</span>
 <span class="mf">76.332368</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">885.22</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">25.710</span> <span class="n">GiB</span><span class="p">,</span> <span class="mf">6.79</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>



<a name="227164355"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164355" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164355">(Feb 21 2021 at 12:23)</a>:</h4>
<p>no</p>



<a name="227164357"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164357" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164357">(Feb 21 2021 at 12:23)</a>:</h4>
<p>that's not your objective function</p>



<a name="227164506"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164506" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164506">(Feb 21 2021 at 12:26)</a>:</h4>
<p>Oh, ok let me try again.</p>



<a name="227164547"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164547" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164547">(Feb 21 2021 at 12:28)</a>:</h4>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code> <span class="mf">1.026235</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">1.75</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">91.610</span> <span class="n">MiB</span><span class="p">,</span> <span class="mf">1.96</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>
<p>This is if I simply run my objective function on the initial condition.</p>



<a name="227164602"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164602" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164602">(Feb 21 2021 at 12:28)</a>:</h4>
<p>yeah so that's generating a ton. That's not good.</p>



<a name="227164608"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164608" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164608">(Feb 21 2021 at 12:28)</a>:</h4>
<p>What if you <code>@code_warntype</code> it?</p>



<a name="227164762"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164762" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164762">(Feb 21 2021 at 12:31)</a>:</h4>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">ERROR</span><span class="o">:</span> <span class="kt">LoadError</span><span class="o">:</span> <span class="kt">LoadError</span><span class="o">:</span> <span class="kt">UndefVarError</span><span class="o">:</span> <span class="nd">@code_warntype</span> <span class="n">not</span> <span class="n">defined</span>
</code></pre></div>
<p>I assume that <code>@code_warntype</code> can only be used in the interpreter?</p>



<a name="227164821"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164821" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164821">(Feb 21 2021 at 12:32)</a>:</h4>
<p>it seems like you need a lot more help than that. You should learn a bit about the language first</p>



<a name="227164824"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164824" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164824">(Feb 21 2021 at 12:32)</a>:</h4>
<p>here's a tutorial that walks through a few things</p>



<a name="227164825"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164825" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164825">(Feb 21 2021 at 12:32)</a>:</h4>
<p><a href="https://mitmath.github.io/18337/lecture2/optimizing">https://mitmath.github.io/18337/lecture2/optimizing</a></p>



<a name="227164826"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164826" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164826">(Feb 21 2021 at 12:32)</a>:</h4>
<p>or as a lecture</p>



<a name="227164827"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164827" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164827">(Feb 21 2021 at 12:33)</a>:</h4>
<p><a href="https://www.youtube.com/watch?v=M2i7sSRcSIw&amp;feature=youtu.be">https://www.youtube.com/watch?v=M2i7sSRcSIw&amp;feature=youtu.be</a></p>
<div class="youtube-video message_inline_image"><a data-id="M2i7sSRcSIw" href="https://www.youtube.com/watch?v=M2i7sSRcSIw&amp;feature=youtu.be"><img src="https://i.ytimg.com/vi/M2i7sSRcSIw/default.jpg"></a></div>



<a name="227164856"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164856" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164856">(Feb 21 2021 at 12:33)</a>:</h4>
<p><a href="https://www.youtube.com/watch?v=10_Ukm9wr9g&amp;feature=youtu.be">https://www.youtube.com/watch?v=10_Ukm9wr9g&amp;feature=youtu.be</a></p>
<div class="youtube-video message_inline_image"><a data-id="10_Ukm9wr9g" href="https://www.youtube.com/watch?v=10_Ukm9wr9g&amp;feature=youtu.be"><img src="https://i.ytimg.com/vi/10_Ukm9wr9g/default.jpg"></a></div>



<a name="227164868"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164868" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164868">(Feb 21 2021 at 12:33)</a>:</h4>
<blockquote>
<p>I assume that @code_warntype can only be used in the interpreter?</p>
</blockquote>



<a name="227164870"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164870" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164870">(Feb 21 2021 at 12:33)</a>:</h4>
<p>no</p>



<a name="227164874"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164874" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164874">(Feb 21 2021 at 12:33)</a>:</h4>
<p><code>using InteractiveUtils</code> or just do <code>Main.@code_warntype</code> as a quick check</p>



<a name="227164878"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164878" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164878">(Feb 21 2021 at 12:34)</a>:</h4>
<p>As a side note, it would be interesting to have a macro, something like <code>@error_if_allocate</code> which you can add to your mission critical function and it wouldn't run, until you fix it.</p>



<a name="227164946"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164946" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164946">(Feb 21 2021 at 12:34)</a>:</h4>
<p>If you want a more direct code optimization and profiling lecture, there's <a href="https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be">https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be</a></p>
<div class="youtube-video message_inline_image"><a data-id="h-xVBD2Pk9o" href="https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be"><img src="https://i.ytimg.com/vi/h-xVBD2Pk9o/default.jpg"></a></div>



<a name="227164977"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227164977" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227164977">(Feb 21 2021 at 12:35)</a>:</h4>
<blockquote>
<p>As a side note, it would be interesting to have a macro, something like @error_if_allocate which you can add to your mission critical function and it wouldn't run, until you fix it.</p>
</blockquote>
<p>Sure, just do <code>@assert @allocated(y=f(x)) == 0</code></p>



<a name="227165712"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227165712" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227165712">(Feb 21 2021 at 12:49)</a>:</h4>
<p><span class="user-mention" data-user-id="278119">@Christopher Rackauckas</span> thank you for the pointers. I have about 1 or 2 days left to speed up the Julia code. I hope I will have enough time to go through the lecture and <a href="https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be">https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be</a>.</p>
<div class="youtube-video message_inline_image"><a data-id="h-xVBD2Pk9o" href="https://www.youtube.com/watch?v=h-xVBD2Pk9o&amp;feature=youtu.be"><img src="https://i.ytimg.com/vi/h-xVBD2Pk9o/default.jpg"></a></div>



<a name="227257823"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227257823" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227257823">(Feb 22 2021 at 12:20)</a>:</h4>
<p>Quick update. <span class="user-mention silent" data-user-id="284959">Andrés Riedemann</span> uncovered the reason why <code>method=:forward</code> autodiff causes error. It is because I use a mutable struct inside my objective functions, where:</p>
<ol>
<li>Its fields are restricted to <code>Float64</code>'s. This causes error because <code>ForwardDiff</code> wants to pass a Dual number containing information about the value and its derivatives. The fields need to be of a <code>Real</code> type.</li>
<li>An array <code>push!</code> update also breaks autodiff, possibly due to the typing as well.</li>
</ol>



<a name="227695388"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227695388" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Große <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227695388">(Feb 24 2021 at 23:48)</a>:</h4>
<p>Did you achieve the performance you wanted?</p>



<a name="227707965"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227707965" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227707965">(Feb 25 2021 at 02:15)</a>:</h4>
<p><span class="user-mention" data-user-id="383122">@Florian Große</span> not yet. My concern is that without optimizations such as autodiff or 0-allocation, the Julia version shouldn't be slower than the Python version, since the Python version is also doing wasteful allocations and not using autodiff. I tried to profile using <a href="https://github.com/search?q=StatProfilerHTML.jl&amp;type=Repositories">StatProfilerHTML.jl</a>, but the line-by-line time spent report is not complete. Not all the relevant lines are time. I wish there is something like Python's <a href="https://github.com/pyutils/line_profiler">https://github.com/pyutils/line_profiler</a>.</p>



<a name="227716105"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227716105" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Große <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227716105">(Feb 25 2021 at 04:30)</a>:</h4>
<p>Agreed. Once you have the paper published and can share the code, it would probably good to open this discussion on Discourse again. If it requires a few tricks to make it run fast, it's probably good to have it there as an example. Either that or you find room for improvement in a julia package, which is also fine.</p>



<a name="227737890"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227737890" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nils <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227737890">(Feb 25 2021 at 09:10)</a>:</h4>
<p>And maybe also #math-optimization, I don't think <span class="user-mention" data-user-id="269196">@Patrick Kofod Mogensen</span> is more active over there I believe</p>



<a name="227840920"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227840920" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Kofod Mogensen <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227840920">(Feb 25 2021 at 21:20)</a>:</h4>
<p>Yeah, hard to say much with the given information. First, I saw you used conjugate gradient descent in the only timing of the real problem I saw. That is really only going to be good (relatively speaking) on very large problems. However, 99% of the times I get these questions, the problem is in the objective function evaluation as <span class="user-mention" data-user-id="278119">@Christopher Rackauckas</span> also tried to guide the conversation towards :) You did not provide a side-by-side timing of your runtime for your objective from python and from julia. I'd like to see that before we can conclude this is related to <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> at all. Next, I'd ask you to print the progress, number of objective function evaluations, number of gradient function evaluations etc. I'm sure we'd be able to match the speed you see in Python, but if you're relatively new to Julia, 2-3 days to get optimal code is not a lot. Hope you get your paper through review, and I'm of course sad that <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> lost a citation over this  ;)</p>



<a name="227847407"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227847407" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227847407">(Feb 25 2021 at 22:07)</a>:</h4>
<p>Yeah I could've been more direct haha. I was trying to slowly guide him to finding out that he likely needed to optimize the objective function that he wrote. But yes, in more direct terms, unless you show your model is non-allocating and type-stable, there is zero evidence to suggest <a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> has an issue and so right now the onus is on the modeler.</p>



<a name="227847527"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227847527" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Rackauckas <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227847527">(Feb 25 2021 at 22:07)</a>:</h4>
<p>The speed of the optimization package itself has relatively little effect on the speed of optimization, other than in the number of steps it takes to get to the optimum. The speed is largely based on the way the user writes the objective (except in the limit of tiny <code>f</code>). A good optimization package takes less steps, which there hasn't been any discussion of "<a href="https://github.com/search?q=Optim.jl&amp;type=Repositories">Optim.jl</a> takes 2-3x as many steps", which would be what points to Optim. Pure timings don't mean that.</p>



<a name="227867906"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227867906" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227867906">(Feb 26 2021 at 01:22)</a>:</h4>
<p>Update: the Julia version is now 2x faster! One major problem is that I defined a named function inside my objective function, to deduplicate some steps, and because the function uses variables local to the objective function (without being passed as arguments). Note: I also do this function-definition-inside-obj-fn in the Python version without much penalty?? Once I move out the function and pass in the local vars as arguments, there are a lot fewer allocations. The Python version takes 5 min 25 s. The Julia version now takes 2 min 12 s (sorry can't publish the code yet). I'm sure there is still room for improvement, but this is already a strong case to convince my collaborators to switch to Julia.</p>



<a name="227868143"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227868143" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227868143">(Feb 26 2021 at 01:25)</a>:</h4>
<p>Note: moving out this function to outside my objective function resulted in 4.5x speedup relative to the previous iteration.</p>



<a name="227869591"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227869591" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227869591">(Feb 26 2021 at 01:42)</a>:</h4>
<p>Before (@time, taken from my previous post)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Optim</span><span class="o">.</span><span class="n">ConjugateGradient</span>
<span class="n">elapsed</span><span class="o">:</span> <span class="mf">74.16639494895935</span>
 <span class="mf">76.332368</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">885.22</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">25.710</span> <span class="n">GiB</span><span class="p">,</span> <span class="mf">6.79</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>
<p>After (@time, including precompilation)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Optim</span><span class="o">.</span><span class="n">ConjugateGradient</span>
<span class="n">elapsed</span><span class="o">:</span> <span class="mf">15.73147702217102</span>
 <span class="mf">17.780150</span> <span class="n">seconds</span> <span class="p">(</span><span class="mf">97.40</span> <span class="n">M</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">9.558</span> <span class="n">GiB</span><span class="p">,</span> <span class="mf">6.34</span><span class="o">%</span> <span class="n">gc</span> <span class="n">time</span><span class="p">)</span>
</code></pre></div>
<p>After (@btime)</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">Optim</span><span class="o">.</span><span class="n">ConjugateGradient</span>
<span class="n">elapsed</span><span class="o">:</span> <span class="mf">12.357237100601196</span>
  <span class="mf">12.357</span> <span class="n">s</span> <span class="p">(</span><span class="mi">92734943</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">9.33</span> <span class="n">GiB</span><span class="p">)</span>
</code></pre></div>
<p>Python version is ~30s.</p>



<a name="227892581"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227892581" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Kofod Mogensen <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227892581">(Feb 26 2021 at 07:42)</a>:</h4>
<p>That sounds great. I of course have to ask: have you checked that the objective values/solution(minimizer) are comparable? There's always a chance that Optim stopped early for some reason. I still have a feeling you could get more performance out of your objective function, but without knowing your exact code it's hard to say. There are indeed a few pitfalls in Julia, and you need to know a little bit (Chris' links would be a great place to start) to get the most out of Julia. I think the function definition that closes over some variables might be a known issue that can sometimes surprise even me and others who are seasoned Julia users (I think you might be hitting this issue specifically <a href="https://github.com/JuliaLang/julia/issues/15276">https://github.com/JuliaLang/julia/issues/15276</a> )</p>



<a name="227899866"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227899866" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrique Ferrolho <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227899866">(Feb 26 2021 at 09:03)</a>:</h4>
<p><span class="user-mention" data-user-id="207815">@Rein Zustand</span>, do you mean that your previous approach was using a <em>closure</em>? I.e., something like below?</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">function</span> <span class="n">aux</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">.*</span> <span class="n">b</span> <span class="o">.+</span> <span class="n">x</span>
    <span class="k">end</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">aux</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">aux</span><span class="p">()</span>

    <span class="n">s</span> <span class="o">.*</span> <span class="n">t</span>
<span class="k">end</span>
</code></pre></div>
<p>And now you have changed it to something like this?</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span> <span class="n">aux</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">.*</span> <span class="n">b</span> <span class="o">.+</span> <span class="n">c</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">aux</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">aux</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">.*</span> <span class="n">t</span>
<span class="k">end</span>
</code></pre></div>



<a name="227900562"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227900562" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227900562">(Feb 26 2021 at 09:09)</a>:</h4>
<p><span class="user-mention" data-user-id="364881">@Henrique Ferrolho</span> yes, exactly.</p>



<a name="227900787"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227900787" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrique Ferrolho <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227900787">(Feb 26 2021 at 09:11)</a>:</h4>
<p>That is odd. I don't think it should make a difference in time or allocations. These are the results I get on my machine when I benchmark the snippets above:</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">julia</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">BenchmarkTools</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="nd">@btime</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  <span class="mf">456.736</span> <span class="n">ns</span> <span class="p">(</span><span class="mi">5</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">4.38</span> <span class="n">KiB</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="nd">@btime</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  <span class="mf">452.822</span> <span class="n">ns</span> <span class="p">(</span><span class="mi">5</span> <span class="n">allocations</span><span class="o">:</span> <span class="mf">4.38</span> <span class="n">KiB</span><span class="p">)</span>
</code></pre></div>



<a name="227901283"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227901283" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227901283">(Feb 26 2021 at 09:16)</a>:</h4>
<p>I will try to provide a snippet that reproduces my situation more closely.</p>



<a name="227901418"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227901418" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrique Ferrolho <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227901418">(Feb 26 2021 at 09:17)</a>:</h4>
<p>Perhaps something else changed when you switched from one approach to the other? What I am trying to say is that the performance improvement you observe should not be due to the use of a closure. I'd be interested to know what the key change was, then.</p>



<a name="227902402"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227902402" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227902402">(Feb 26 2021 at 09:27)</a>:</h4>
<p>! Gotcha. I just checked my commit. I did turn a model parameter defined in a global setting into a const, together with the change that moved out the function to be outside of the objective commit, all within a single commit. My bad.</p>
<p>I tried reverting by putting the function back inside my objective function, while keeping the variable a const, and I got the same allocation. I am very sorry for the false alarm.</p>



<a name="227903364"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227903364" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrique Ferrolho <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227903364">(Feb 26 2021 at 09:37)</a>:</h4>
<p>No need to apologise. So, the improvement was actually thanks to declaring a global variable as <code>const</code>.  Did I get that right?</p>



<a name="227903567"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227903567" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227903567">(Feb 26 2021 at 09:40)</a>:</h4>
<p>Yes, I have isolated the cause to be indeed setting the const. Reverting it back to without const slows down the btime by ~4x.</p>



<a name="227904066"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227904066" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrique Ferrolho <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227904066">(Feb 26 2021 at 09:44)</a>:</h4>
<p>Great! In general, it is best to avoid global variables. But if you do want to have a global variable, it is critical to make it <code>const</code>, otherwise the compiler assumes that its value and type can change at any point, and thus it is not able to specialise on one given type. This is mentioned in <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#Avoid-global-variables">Performance Tips &gt; Avoid global variables</a>. (The entire <em>Performance Tips</em> is gold. Do read it, if you haven't. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span>)</p>



<a name="227906303"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227906303" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227906303">(Feb 26 2021 at 10:07)</a>:</h4>
<p>For that Performance tips article. It recommends <code>@time</code> instead of <code>@btime</code>. I suppose because <a href="https://github.com/search?q=BenchmarkTools.jl&amp;type=Repositories">BenchmarkTools.jl</a> is an external tool, and so the official manual can't recommend it?</p>



<a name="227906710"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/227906710" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#227906710">(Feb 26 2021 at 10:11)</a>:</h4>
<p>Hmmm... At the end of the section <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#Measure-performance-with-klzzwxh:0000-and-pay-attention-to-memory-allocation">https://docs.julialang.org/en/v1/manual/performance-tips/#Measure-performance-with-<a href="mailto:@ref">@time</a>-and-pay-attention-to-memory-allocation</a> there is a note "For more serious benchmarking, consider the <a href="https://github.com/search?q=BenchmarkTools.jl&amp;type=Repositories">BenchmarkTools.jl</a> package which among other things evaluates the function multiple times in order to reduce noise."</p>



<a name="228355951"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228355951" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228355951">(Mar 02 2021 at 05:28)</a>:</h4>
<p>I hit a new roadblock with Optim's conjugate gradient. The parameters for my objective function are bounded by 0 &lt;= x &lt;= 1. While <code>Optim.ConjugateGradient</code> is fast, sometimes I observe a discontinuous spike in my result. I observed similar spikes too in scipy, but at least in scipy, the spikes consistently disappear if I use <code>L-BFGS-B</code>. There is a <code>Optim.LBFGS</code> in <code>Optim</code>, but it is 7x slower than <code>Optim.ConjugateGradient</code> (so, in effect, Optim is 3.5x slower than scipy).</p>
<p>By using <code>Optim.ConjugateGradient</code> I'm making my comparison closer to apple-to-apple with the scipy version. I have pre-allocated my mutable structs to reduce allocations, and this still doesn't improve the time spent significantly.</p>
<p>Unfortunately, I'm short of time to investigate the cause further, and am forced to use the scipy version to continue my research. <span aria-label="oh no" class="emoji emoji-1f615" role="img" title="oh no">:oh_no:</span></p>



<a name="228356316"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228356316" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228356316">(Mar 02 2021 at 05:33)</a>:</h4>
<p>s/By using <code>Optim.ConjugateGradient</code>/By using <code>Optim.LBFGS</code>/. (I realized that zulip-archive doesn't handle message edits). test</p>



<a name="228357936"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228357936" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228357936">(Mar 02 2021 at 05:57)</a>:</h4>
<p>Are your allocations down to zero?</p>



<a name="228357954"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228357954" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mason Protter <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228357954">(Mar 02 2021 at 05:57)</a>:</h4>
<p>I.e. are you allocating new arrays in each iteration?</p>



<a name="228382038"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228382038" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228382038">(Mar 02 2021 at 09:54)</a>:</h4>
<p>My allocations are not exactly zero, but they are about 33k now (used to be 6M). But then, the Python version is doing wasteful allocations. I'd expect the Julia version to be at worst comparable to the Python version (because I'm doing equivalent wasteful allocations in Python), and then progressively gets better when I reduce allocations. Is it wrong to think this way?</p>
<p>Another degree of freedom to consider is that the default params of the LBFGS in each params might differ as <span class="user-mention silent" data-user-id="269196">Patrick Kofod Mogensen</span> stated in <a href="#narrow/stream/274208-helpdesk-%28published%29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F/near/227892581">https://julialang.zulipchat.com/#narrow/stream/274208-helpdesk-%28published%29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F/near/227892581</a>.</p>



<a name="228383087"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228383087" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228383087">(Mar 02 2021 at 10:03)</a>:</h4>
<p>It's not only about number of allocation, but about there "quality".</p>
<p>If for example you are slicing your array, you are making it's copy (and python uses analogue of Julia views).<br>
So, if you have something like </p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">v1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="mi">1_000_000_000</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">500_000_000</span><span class="p">]</span>
</code></pre></div>
<p>you are doing maybe 2 or 3 allocations, but you are also copying half of your computer memory to a new place and as a result computations are slow.</p>
<p>Also, if there are some issues with type stability, you also waste precious time on dynamical dispatch.</p>
<p>If the following example</p>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="n">v</span> <span class="o">=</span> <span class="kt">Any</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>compiler spend 0.01 ns to make actual addition and 10ns to figure out the type of the <code>v[1]</code> variable (and also it has to pack <code>c</code> back to <code>Any</code>). So if this addition is a part of tight loop you can get huge slowdown. Since python usually vectorize such operation, it avoids this problem. I think in this case you can compare vectorization to function barriers, i.e. vector has rather bad type as an input, but inside the function it knows that all elements have some good type and do not waste time trying to figure out type of each element individually.</p>



<a name="228385343"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228385343" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228385343">(Mar 02 2021 at 10:20)</a>:</h4>
<p>Thank you for the elaboration. I have checked the allocations using <code>--track-allocation=user</code> and found no such copying. For the type stability issue, my <code>@code_warntype</code> output is mostly green and yellow (for the loop variable). I have to note though that in my case, I do regular loops in the Python version because the operation can't be vectorized (it's a time evolution), so surely Python must be doing regular <code>object</code> operations.</p>



<a name="228386535"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228386535" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kwaku Oskin <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228386535">(Mar 02 2021 at 10:29)</a>:</h4>
<p>Oh, those were meant only as examples. There can be other reasons why reasonably small number of allocations can have a large impact on the performance.</p>



<a name="228389365"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228389365" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228389365">(Mar 02 2021 at 10:52)</a>:</h4>
<p>s/mostly green and yellow/mostly green, but the rest is yellow/</p>



<a name="228394871"></a>
<h4><a href="https://julialang.zulipchat.com#narrow/stream/274208-helpdesk%20%28published%29/topic/why%20is%20Optim.jl%20so%20slow%3F/near/228394871" class="zl"><img src="https://juliacommunity.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://juliacommunity.github.io/zulip-archive/stream/274208-helpdesk-.28published.29/topic/why.20is.20Optim.2Ejl.20so.20slow.3F.html#228394871">(Mar 02 2021 at 11:36)</a>:</h4>
<p>I'm down to only 1 allocation, which is due to <del><code>@assert length(xs) == length(Ts)</code></del> (hold up, it's not it, still investigating). Still about as slow. By process of elimination, the remaining uncertainty is in the LBFGS implementation of <code>Optim</code> vs <code>scipy.optimize</code>.</p>



<hr><p>Last updated: Mar 02 2026 at 05:32 UTC</p>
</html>